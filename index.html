<!-- Back-up Code(With UI and UX) -->
<!DOCTYPE html>
<!-- Add data-theme="dark" for default dark mode, or JS will handle it -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker - Material You</title>
    <!-- 1. FONT: Use Roboto + Google Sans (for expressive headlines) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- 2. ICONS: Switched to Material Symbols Outlined per new principles -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">

    <!-- 3. CHART.JS: For advanced analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* ---
         * NEW DESIGN SYSTEM (Based on your M3 Expressive Principles)
         * ---
         */

        /* 1. Static Dynamic Color System & 6. Tonal Hierarchy */
        :root {
            /* Primary Palette */
            --color-primary: #1A73E8;
            --color-primary-hover: #1765CC; 
            --color-primary-container: rgba(26, 115, 232, 0.08); /* For flash */
            --color-on-primary: #FFFFFF;

            /* Secondary (Neutral) Palette */
            --color-secondary: #5F6368;
            --color-on-secondary: #FFFFFF;

            /* REFINEMENT: Principle 6 - Accent Color */
            --color-accent-gold: #FBBC04;
            --color-on-accent-gold: #202124;

            /* Status Colors */
            --color-error: #EA4335;
            --color-on-error: #FFFFFF;
            --color-success: #34A853;
            --color-warning: #FBBC04;

            /* Surface & Tones */
            --color-surface: #FFFFFF;
            --color-on-surface: #202124;
            --color-on-surface-variant: #5F6368; /* Using secondary for variant text */
            
            /* Tonal surfaces from principle 6, mapped to names from principle 1 */
            --color-surface-tone-1: #FFFFFF; /* --tone-surface-1 */
            --color-surface-tone-2: #F8F9FA; /* --tone-surface-2 */
            --color-surface-tone-3: #E8EAED; /* --tone-surface-3 */
            
            /* --color-surface-elevated from principle 1 */
            --color-surface-elevated: #F8F9FA; 

            /* Outline */
            --color-outline: #DADCE0;
            --color-outline-faint: rgba(60, 64, 67, 0.1); /* For dots */
            
            /* 2. Simplified Shape System */
            --radius-small: 4px;
            --radius-medium: 8px;
            --radius-large: 12px;
            --radius-extra: 16px;
            --radius-full: 9999px;

            /* 4. Expressive Motion */
            --motion-fast: 150ms ease-out;
            --motion-medium: 250ms cubic-bezier(0.2, 0, 0, 1);
            --motion-slow: 400ms cubic-bezier(0.2, 0, 0, 1);

            /* 5. Static Expressive Typography */
            /* Using 'Google Sans' for expressive, 'Roboto' for body */
            --font-display: 57px/1.2 'Google Sans', sans-serif;
            --font-headline: 32px/1.25 'Google Sans', sans-serif;
            --font-title: 22px/1.3 'Google Sans', sans-serif;
            --font-body: 16px/1.6 'Roboto', sans-serif;
            --font-label: 14px/1.4 'Roboto', sans-serif;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
        }

        /* Dark Theme (from Principle 1) */
        /* Applied via body.dark-mode instead of data-theme */
        body.dark-mode {
            --color-primary: #8AB4F8;
            --color-primary-hover: #a3c5f8;
            --color-primary-container: rgba(138, 180, 248, 0.1); /* For flash */
            --color-on-primary: #202124;
            
            --color-secondary: #E8EAED;
            
            --color-surface: #202124;
            --color-on-surface: #E8EAED;
            --color-on-surface-variant: #DADCE0;

            --color-surface-tone-1: #202124;
            --color-surface-tone-2: #2A2B2F;
            --color-surface-tone-3: #343538;
            
            --color-surface-elevated: #2A2B2F;

            --color-outline: #5F6368;
            --color-outline-faint: rgba(232, 234, 237, 0.1); /* For dots */
        }

        /* ---
         * UTILITY CLASSES
         * ---
         */
        
        /* 3. Tonal Elevation & Shadows */
        .elevation-1 {
            background: var(--color-surface);
            box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3);
        }
        .elevation-2 {
            background: var(--color-surface-elevated);
            box-shadow: 0 2px 6px rgba(60, 64, 67, 0.25);
        }
        .elevation-3 {
            background: var(--color-surface-elevated);
            box-shadow: 0 4px 8px rgba(60, 64, 67, 0.25);
        }
        
        /* 4. Expressive Motion Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 8. State Layer (for buttons) */
        .state-layer-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit; /* Inherit button's border-radius */
            background: rgba(26, 115, 232, 0); /* --color-primary as RGB */
            transition: background var(--motion-fast);
        }
        .state-layer-primary:hover::after { background: rgba(26, 115, 232, 0.08); }
        .state-layer-primary:active::after { background: rgba(26, 115, 232, 0.12); }
        
        /* State layer for neutral/text buttons */
        .state-layer-secondary::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: rgba(95, 99, 104, 0); /* --color-secondary as RGB */
            transition: background var(--motion-fast);
        }
        .state-layer-secondary:hover::after { background: rgba(95, 99, 104, 0.08); }
        .state-layer-secondary:active::after { background: rgba(95, 99, 104, 0.12); }
        
        /* State layer for white-on-primary buttons */
        .state-layer-on-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: rgba(255, 255, 255, 0);
            transition: background var(--motion-fast);
        }
        .state-layer-on-primary:hover::after { background: rgba(255, 255, 255, 0.1); }
        .state-layer-on-primary:active::after { background: rgba(255, 255, 255, 0.15); }
        
        /* State layer for dark mode toggle */
        body.dark-mode .state-layer-on-primary:hover::after { background: rgba(138, 180, 248, 0.1); } /* #8AB4F8 */
        body.dark-mode .state-layer-on-primary:active::after { background: rgba(138, 180, 248, 0.15); }

        /* ---
         * BASE STYLES
         * ---
         */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* 5. Typography: Use --font-body */
            font: var(--font-body);
            background-color: var(--color-surface);
            color: var(--color-on-surface);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            transition: background-color var(--motion-fast), color var(--motion-fast);
            
            /* REFINEMENT: Principle 1 & 5 - Add subtle dot pattern */
            background-image: radial-gradient(var(--color-outline-faint) 0.5px, transparent 0.5px);
            background-size: 8px 8px;
        }

        /* 7. Optimized Icon System */
        /* Targets the existing class but applies new principles */
        .material-symbols-rounded,
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined'; /* Use Outlined */
            font-size: 24px;
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
            color: var(--color-secondary);
            vertical-align: middle;
            user-select: none;
        }
        
        /* 11. Accessibility Optimizations */
        :focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
            border-radius: var(--radius-small);
        }

        @media (prefers-reduced-motion: reduce) {
            * { 
                animation: none !important; 
                transition: none !important; 
            }
        }
        
        /* ---
         * COMPONENT STYLES
         * ---
         */

        /* --- Login Modal --- */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-surface-tone-3); /* Use tone */
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--motion-medium), visibility var(--motion-medium), background-color var(--motion-fast);
        }

        .auth-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .auth-modal {
            /* Use elevation and shape */
            background: var(--color-surface);
            border-radius: var(--radius-large); /* 12px */
            padding: 32px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(60,64,67,0.25); /* elevation-3 */
            text-align: center;
            animation: fadeIn var(--motion-medium) forwards;
            transition: background-color var(--motion-fast);
        }

        .auth-title {
            /* 5. Typography */
            font: var(--font-title);
            color: var(--color-on-surface);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .auth-title .material-symbols-outlined {
            color: var(--color-primary);
            font-size: 28px;
        }

        .auth-subtitle {
            font: var(--font-label);
            font-size: 16px; /* A bit bigger */
            color: var(--color-on-surface-variant);
            margin-bottom: 24px;
        }

        .input-group {
            margin-bottom: 16px;
            text-align: left;
        }

        .input-label {
            font: var(--font-label);
            color: var(--color-primary);
            margin-bottom: 8px;
            display: block;
            font-weight: var(--font-weight-medium);
            padding-left: 16px;
        }

        .input-field {
            width: 100%;
            padding: 16px;
            font: var(--font-body);
            border: 2px solid var(--color-outline);
            border-radius: var(--radius-medium); /* 8px */
            background: var(--color-surface-tone-2);
            color: var(--color-on-surface);
            transition: border-color var(--motion-fast), box-shadow var(--motion-fast), background-color var(--motion-fast), color var(--motion-fast);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary-hover);
        }

        .auth-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
            margin-top: 16px;
        }

        .toggle-auth {
            background: none;
            border: none;
            color: var(--color-primary);
            font: var(--font-label);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-full);
            position: relative;
            overflow: hidden;
        }

        .auth-error {
            font: var(--font-label);
            color: var(--color-error);
            margin-top: 16px;
            display: none;
        }

        /* --- Main App --- */
        .app-container {
            display: none;
        }
        .app-container.show {
            display: block;
        }

        /* App Bar */
        .app-bar {
            background: var(--color-primary);
            color: var(--color-on-primary);
            padding: 24px 20px;
            /* Use shadow for depth */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: box-shadow var(--motion-fast);
        }
        
        /* NEW: Dynamic app bar shadow on scroll */
        .app-bar.scrolled {
            box-shadow: 0 2px 6px rgba(60, 64, 67, 0.25); /* elevation-2 */
        }

        .app-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            /* 5. Typography: --font-headline */
            font: var(--font-headline);
            letter-spacing: 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .app-title .material-symbols-outlined {
            color: var(--color-on-primary);
            font-size: 32px;
        }

        .app-subtitle {
            font: var(--font-label);
            font-size: 16px;
            opacity: 0.9;
            font-weight: var(--font-weight-regular);
        }
        
        .app-bar-actions {
            display: flex;
            align-items: center;
            gap: 8px; /* Reduced gap */
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center; /* Center the icon */
            gap: 8px;
            padding: 8px; /* Reduced padding for icon-only */
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-full);
            font: var(--font-label);
            backdrop-filter: blur(10px);
            width: 40px; /* Fixed size for circle */
            height: 40px;
        }
        .sync-status .material-symbols-outlined {
            color: var(--color-on-primary);
            font-size: 20px; /* Slightly smaller icon */
            margin: 0; /* Remove potential margins */
        }

        .sync-status.syncing .material-symbols-outlined {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* General Buttons */
        .filled-button, .outlined-button, .today-button, .text-button, .icon-button {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: none;
            font-weight: var(--font-weight-medium);
            letter-spacing: 0.5px;
            transition: transform var(--motion-fast), box-shadow var(--motion-fast), background-color var(--motion-fast), color var(--motion-fast), border-color var(--motion-fast);
            -webkit-tap-highlight-color: transparent;
        }
        .filled-button:active, .outlined-button:active, .today-button:active, .text-button:active, .icon-button:active {
            transform: scale(0.97);
        }
        
        /* 8. State Layers applied */
        .filled-button, .today-button {
            background: var(--color-primary);
            color: var(--color-on-primary);
            padding: 12px 24px;
            border-radius: var(--radius-full); /* Rounded */
            font: var(--font-label);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .filled-button:hover, .today-button:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .filled-button:disabled, .today-button:disabled {
            background: var(--color-outline);
            color: var(--color-on-surface-variant);
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }

        .outlined-button {
            background: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-outline);
            padding: 12px 24px;
            border-radius: var(--radius-full); /* Rounded */
            font: var(--font-label);
        }
        .outlined-button:hover {
            background: rgba(26, 115, 232, 0.08); /* state-layer-primary hover */
        }

        .icon-button {
            background: var(--color-surface-tone-2);
            color: var(--color-on-surface-variant);
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full); /* Circle */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .icon-button .material-symbols-outlined {
            color: var(--color-on-surface-variant);
            font-size: 24px;
            transition: color var(--motion-fast);
        }
        .icon-button:hover {
            background: var(--color-surface-tone-3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .icon-button:disabled {
            background: var(--color-surface-tone-2);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .text-button {
            background: none;
            color: var(--color-on-primary);
            font: var(--font-label);
            font-weight: var(--font-weight-medium);
            padding: 10px 12px;
            border-radius: var(--radius-full);
        }
        
        /* Dark mode toggle button style */
        .theme-toggle-button {
            background: none;
            border: none;
            color: var(--color-on-primary);
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle-button .material-symbols-outlined {
            color: var(--color-on-primary);
            font-size: 20px;
        }
        body.dark-mode .theme-toggle-button .material-symbols-outlined {
             color: var(--color-primary); /* #8AB4F8 */
        }
        /* Hide one icon based on theme */
        body:not(.dark-mode) #icon-dark-mode { display: none; }
        body.dark-mode #icon-light-mode { display: none; }

        /* --- Container & Cards --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .setup-banner {
            background: var(--color-warning); /* Use warning color */
            border-radius: var(--radius-large);
            padding: 24px;
            margin-bottom: 24px;
            display: none;
            animation: fadeIn var(--motion-medium);
            color: var(--color-on-surface); /* Text on warning */
        }
        .setup-banner.show { display: block; }
        .setup-banner h3 { font: var(--font-title); }
        .setup-banner p { font: var(--font-label); line-height: 1.6; }
        .setup-banner a { color: var(--color-primary); }

        .date-card {
            /* REFINEMENT: Principle #1 - Use prominent background tint */
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large); /* 12px */
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3); /* elevation-1 */
            animation: fadeIn var(--motion-medium) forwards;
        }

        .date-header { text-align: center; margin-bottom: 20px; }
        .current-date { font: var(--font-headline); }
        .date-subtext {
            font: var(--font-label);
            color: var(--color-on-surface-variant);
            min-height: 20px; /* Reserve space for microcopy */
            transition: all var(--motion-fast);
        }
        .date-nav { display: flex; justify-content: center; gap: 12px; align-items: center; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            /* REFINEMENT: Principle #1 - Use 8dp grid system (16px gap) */
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--color-surface-tone-2);
            /* REFINEMENT: Principle #1 - Use 16-24dp radius */
            border-radius: var(--radius-extra); /* 16px */
            padding: 20px;
            text-align: center;
            transition: all var(--motion-fast);
            animation: fadeIn var(--motion-medium) forwards;
            animation-delay: calc(var(--index, 1) * 50ms); /* Stagger */
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(60,64,67,0.25); /* elevation-2 */
        }
        .stat-icon { font-size: 32px; margin-bottom: 8px; }
        .stat-icon .material-symbols-outlined {
            font-size: 32px;
            font-variation-settings: 'FILL' 1;
        }
        
        /* REFINEMENT: Principle #4 - Color-coded icons */
        #weekProgressIcon .material-symbols-outlined { color: var(--color-primary); }
        #totalCheckinsIcon .material-symbols-outlined { color: var(--color-accent-gold); }
        #bestStreakIcon .material-symbols-outlined { color: var(--color-error); }
        #avgCompletionIcon .material-symbols-outlined { color: var(--color-success); }
        
        .stat-value { font: var(--font-headline); margin-bottom: 4px; }
        .stat-label { font: var(--font-label); color: var(--color-on-surface-variant); text-transform: uppercase; }

        /* Habits List */
        .habits-section {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large); /* 12px */
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3); /* elevation-1 */
            min-height: 100px;
        }
        
        .habits-list-empty-state {
            padding: 40px 24px;
            text-align: center;
            color: var(--color-on-surface-variant);
        }
        .habits-list-empty-state .material-symbols-outlined { font-size: 48px; color: var(--color-outline); }
        .habits-list-empty-state h3 { font: var(--font-title); }
        .habits-list-empty-state p { font: var(--font-label); font-size: 16px; }

        .habit-card {
            background: var(--color-surface);
            border-radius: var(--radius-medium); /* 8px */
            padding: 20px;
            margin: 8px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all var(--motion-fast);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(60,64,67,0.2);
        }
        /* REFINEMENT: Principle 7 - Flash animation */
        .habit-card.flash {
            animation: flash-accent var(--motion-slow);
        }
        @keyframes flash-accent {
            0% { background-color: var(--color-primary-container); }
            100% { background-color: var(--color-surface); }
        }
        body.dark-mode .habit-card.flash {
            animation: flash-accent-dark var(--motion-slow);
        }
        @keyframes flash-accent-dark {
            0% { background-color: var(--color-primary-container); }
            100% { background-color: var(--color-surface); }
        }
        
        .habit-card:hover {
            box-shadow: 0 2px 6px rgba(60,64,67,0.25); /* elevation-2 */
            transform: translateY(-1px);
        }
        .habit-card.completed {
            background: var(--color-surface-tone-3);
        }
        .habit-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--habit-color);
            border-radius: 4px 0 0 4px;
        }

        /* Custom Checkbox */
        .habit-checkbox-wrapper { width: 28px; height: 28px; flex-shrink: 0; z-index: 2; }
        .habit-checkbox {
            appearance: none;
            width: 28px;
            height: 28px;
            border: 2px solid var(--color-outline);
            border-radius: var(--radius-medium); /* 8px */
            cursor: pointer;
            position: relative;
            transition: all var(--motion-fast);
            background: var(--color-surface);
        }
        .habit-checkbox:checked { background: var(--habit-color); border-color: var(--habit-color); }
        .habit-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 18px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            /* REFINEMENT: Principle #5 - Check animation */
            animation: checkPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* REFINEMENT: Principle #5 - Keyframes for check */
        @keyframes checkPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .habit-checkbox:hover { border-color: var(--color-primary); }
        .habit-checkbox:disabled { opacity: 0.4; cursor: not-allowed; }

        .habit-icon { font-size: 32px; flex-shrink: 0; pointer-events: none; }
        .habit-content {
            flex: 1;
            min-width: 0;
            pointer-events: none;
            padding-bottom: 12px; /* Space for progress bar */
        }
        .habit-name { font: var(--font-body); font-size: 18px; font-weight: var(--font-weight-medium); }
        .habit-schedule { font: var(--font-label); color: var(--color-on-surface-variant); }
        /* REFINEMENT: Principle 4 - "Why" text */
        .habit-why {
            font: var(--font-label);
            color: var(--color-primary);
            font-style: italic;
            font-size: 13px;
            margin-top: 4px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* REFINEMENT: Principle 3 - Progress Bar */
        .habit-progress-bar-container {
            position: absolute;
            bottom: 8px;
            left: 20px;
            right: 20px;
            height: 6px;
            background: var(--color-outline);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        .habit-progress-bar {
            height: 100%;
            width: 0%; /* Set by JS */
            background: var(--color-primary);
            border-radius: var(--radius-full);
            transition: width var(--motion-slow);
        }
        
        .habit-menu { z-index: 2; }
        .habit-menu .icon-button { background: transparent; box-shadow: none; }
        .habit-menu .icon-button:hover { background: var(--color-surface-tone-3); }

        /* Dropdown Menu */
        .dropdown { position: relative; }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 44px;
            background-color: var(--color-surface);
            min-width: 160px;
            box-shadow: 0 4px 8px rgba(60,64,67,0.25); /* elevation-3 */
            border-radius: var(--radius-large); /* 12px */
            z-index: 10;
            padding: 8px;
            border: 1px solid var(--color-outline);
            animation: fadeIn 100ms ease-out;
        }
        .dropdown-content.show { display: block; }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font: var(--font-label);
            color: var(--color-on-surface);
            padding: 12px;
            border-radius: var(--radius-medium);
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        .dropdown-item .material-symbols-outlined { color: var(--color-on-surface-variant); }
        .dropdown-item:hover { background-color: var(--color-surface-tone-2); }
        .dropdown-item.delete { color: var(--color-error); }
        .dropdown-item.delete .material-symbols-outlined { color: var(--color-error); }
        .dropdown-item.delete:hover { background-color: rgba(234, 67, 53, 0.1); }

        /* Export Section */
        .export-section {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large);
            padding: 24px;
            text-align: center;
        }
        .export-section h3 { font: var(--font-title); }
        .export-section p { font: var(--font-label); color: var(--color-on-surface-variant); margin-bottom: 16px; }
        /* REFINEMENT: Principle #6 - Privacy note */
        .export-privacy-note {
            font: var(--font-label);
            font-size: 12px;
            color: var(--color-on-surface-variant);
            margin-top: 16px;
        }

        /* Progress Ring */
        .progress-ring-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 20px auto;
        }
        /* REFINEMENT: Principle 1 - Pop animation */
        .progress-ring-container.pop {
            animation: pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle {
            /* REFINEMENT: Principle #3 - Animate progress ring */
            transition: stroke-dashoffset var(--motion-slow);
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }
        .progress-ring-bg { fill: none; stroke: var(--color-outline); stroke-width: 8; }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font: var(--font-headline);
            color: var(--color-primary);
        }

        /* Celebration */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-surface);
            color: var(--color-on-surface);
            padding: 32px;
            border-radius: var(--radius-extra); /* 16px */
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            display: none;
        }
        .celebration.show {
            display: block;
            animation: celebrationPop var(--motion-slow);
        }
        /* REFINEMENT: Principle #8 - Celebration animation */
        @keyframes celebrationPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .celebration-emoji { font-size: 64px; margin-bottom: 16px; }
        .celebration-text { font: var(--font-title); }
        .celebration-subtext { font: var(--font-label); color: var(--color-on-surface-variant); }
        
        /* REFINEMENT: Principle 7 - Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            pointer-events: none;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            top: -10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-title { font: var(--font-title); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .date-nav { flex-direction: column; }
            .today-button { width: 100%; }
            .app-bar-content { flex-direction: column; gap: 12px; align-items: flex-start; }
            .app-bar-actions { width: 100%; justify-content: space-between; }
        }

        /* Fab Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--color-primary);
            color: var(--color-on-primary);
            border: none;
            border-radius: var(--radius-extra); /* 16px */
            box-shadow: 0 4px 8px rgba(60,64,67,0.25); /* elevation-3 */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: all var(--motion-medium);
        }
        .fab .material-symbols-outlined { color: var(--color-on-primary); font-size: 24px; }
        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(60,64,67,0.4);
        }
        .fab:active { transform: scale(0.95); }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #323232; /* Standard snackbar color */
            color: #FFFFFF;
            padding: 16px 24px;
            border-radius: var(--radius-medium);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            transition: transform var(--motion-medium);
            display: flex;
            align-items: center;
            gap: 12px;
            font: var(--font-label);
        }
        .snackbar .material-symbols-outlined { color: var(--color-success); }
        .snackbar.show { transform: translateX(-50%) translateY(0); }
        
        /* Modal Base */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--motion-medium), visibility var(--motion-medium);
            backdrop-filter: blur(5px);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        
        .modal {
            background: var(--color-surface);
            border-radius: var(--radius-large); /* 12px */
            padding: 24px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity var(--motion-medium), transform var(--motion-medium), background-color var(--motion-fast);
        }
        .modal-overlay.show .modal { opacity: 1; transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font: var(--font-title); }
        .modal-body { margin-bottom: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; }
        
        /* Color Picker */
        .color-picker { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--motion-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .color-swatch.selected {
            border-color: var(--color-primary);
            transform: scale(1.1);
        }
        
        /* Form Styles (re-used in modal) */
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-label { font: var(--font-label); font-weight: var(--font-weight-medium); color: var(--color-on-surface-variant); }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            font: var(--font-body);
            border: 1px solid var(--color-outline);
            border-radius: var(--radius-medium);
            background: var(--color-surface-tone-2);
            color: var(--color-on-surface);
            transition: all var(--motion-fast);
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary-hover);
        }
        .form-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='%235F6368'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }
        body.dark-mode .form-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='%23DADCE0'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        }
        
        /* Heatmap Modal */
        #heatmapModal .modal { max-width: 90%; width: auto; }
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(26, 16px);
            grid-template-rows: repeat(7, 16px);
            grid-auto-flow: column;
            grid-gap: 3px;
            justify-content: center;
            margin-top: 16px;
            padding-right: 16px;
        }
        .heatmap-day {
            width: 16px;
            height: 16px;
            background-color: var(--color-surface-tone-2);
            border-radius: var(--radius-small);
            position: relative;
        }
        .heatmap-day.filled { background-color: var(--habit-color); }
        .heatmap-day.na { background-color: transparent; }
        .heatmap-day.missed { background-color: var(--color-surface-tone-3); }
        .heatmap-day.today { border: 1px solid var(--color-primary); }
        .heatmap-legend { display: flex; justify-content: center; gap: 16px; margin-top: 16px; font: var(--font-label); }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: var(--radius-small); }

        /* ---
         * ANALYTICS DASHBOARD STYLES
         * ---
         */

        /* Analytics Navigation Tabs */
        .analytics-tabs {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large);
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3);
        }

        .analytics-tab {
            background: transparent;
            color: var(--color-on-surface-variant);
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius-medium);
            font: var(--font-label);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--motion-fast);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analytics-tab:hover {
            background: var(--color-surface-tone-3);
        }

        .analytics-tab.active {
            background: var(--color-primary);
            color: var(--color-on-primary);
        }

        .analytics-tab .material-symbols-outlined {
            font-size: 20px;
        }

        /* Analytics Content Sections */
        .analytics-content {
            display: none;
        }

        .analytics-content.active {
            display: block;
            animation: fadeIn var(--motion-medium) forwards;
        }

        /* Chart Containers */
        .chart-card {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3);
        }

        .chart-card h3 {
            font: var(--font-title);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-card h3 .material-symbols-outlined {
            color: var(--color-primary);
            font-size: 24px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 16px;
        }

        .chart-wrapper.small {
            height: 200px;
        }

        .chart-wrapper.large {
            height: 400px;
        }

        /* Analytics Stats Mini Grid */
        .analytics-mini-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .mini-stat-card {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-medium);
            padding: 16px;
            text-align: center;
        }

        .mini-stat-value {
            font: var(--font-title);
            color: var(--color-primary);
            margin-bottom: 4px;
        }

        .mini-stat-label {
            font: var(--font-label);
            font-size: 12px;
            color: var(--color-on-surface-variant);
            text-transform: uppercase;
        }

        /* Heatmap Filters */
        .heatmap-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font: var(--font-label);
            color: var(--color-on-surface-variant);
            font-weight: var(--font-weight-medium);
        }

        .filter-select {
            padding: 8px 12px;
            font: var(--font-label);
            border: 1px solid var(--color-outline);
            border-radius: var(--radius-medium);
            background: var(--color-surface);
            color: var(--color-on-surface);
            cursor: pointer;
            transition: all var(--motion-fast);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary-container);
        }

        /* Enhanced Heatmap Grid */
        .enhanced-heatmap-grid {
            display: grid;
            grid-template-columns: 40px repeat(auto-fill, 14px);
            grid-auto-rows: 14px;
            grid-gap: 3px;
            justify-content: start;
            margin-top: 16px;
            font: var(--font-label);
            font-size: 10px;
        }

        .heatmap-day-label {
            text-align: right;
            padding-right: 8px;
            color: var(--color-on-surface-variant);
            font: var(--font-label);
            font-size: 10px;
            line-height: 14px;
        }

        .heatmap-month-label {
            color: var(--color-on-surface-variant);
            font: var(--font-label);
            font-size: 10px;
            text-align: center;
            margin-bottom: 4px;
        }

        .enhanced-heatmap-day {
            width: 14px;
            height: 14px;
            border-radius: var(--radius-small);
            background: var(--color-surface-tone-3);
            transition: all var(--motion-fast);
            cursor: pointer;
            position: relative;
        }

        .enhanced-heatmap-day:hover {
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .enhanced-heatmap-day.intensity-1 {
            opacity: 0.25;
        }

        .enhanced-heatmap-day.intensity-2 {
            opacity: 0.5;
        }

        .enhanced-heatmap-day.intensity-3 {
            opacity: 0.75;
        }

        .enhanced-heatmap-day.intensity-4 {
            opacity: 1;
        }

        .enhanced-heatmap-day.filled {
            background: var(--color-primary);
        }

        /* Heatmap Tooltip */
        .heatmap-tooltip {
            position: absolute;
            background: var(--color-surface);
            color: var(--color-on-surface);
            padding: 8px 12px;
            border-radius: var(--radius-medium);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font: var(--font-label);
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--motion-fast);
            border: 1px solid var(--color-outline);
        }

        .heatmap-tooltip.show {
            opacity: 1;
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font: var(--font-label);
        }

        .comparison-table th {
            background: var(--color-surface-tone-3);
            padding: 12px;
            text-align: left;
            font-weight: var(--font-weight-medium);
            border-bottom: 2px solid var(--color-outline);
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--color-outline);
        }

        .comparison-table tr:hover {
            background: var(--color-surface-tone-2);
        }

        .comparison-table .habit-icon-cell {
            font-size: 20px;
            width: 40px;
        }

        .comparison-progress-bar {
            height: 6px;
            background: var(--color-outline);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: 4px;
        }

        .comparison-progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: var(--radius-full);
            transition: width var(--motion-slow);
        }

        /* Insights Cards */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .insight-card {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large);
            padding: 20px;
            box-shadow: 0 1px 2px rgba(60,64,67,0.3);
        }

        .insight-card h4 {
            font: var(--font-body);
            font-weight: var(--font-weight-medium);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-card h4 .material-symbols-outlined {
            color: var(--color-primary);
            font-size: 20px;
        }

        .insight-list {
            list-style: none;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-outline);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-item-icon {
            font-size: 24px;
        }

        .insight-item-content {
            flex: 1;
        }

        .insight-item-name {
            font-weight: var(--font-weight-medium);
        }

        .insight-item-stat {
            font: var(--font-label);
            color: var(--color-on-surface-variant);
            font-size: 12px;
        }

        .insight-item-badge {
            background: var(--color-primary);
            color: var(--color-on-primary);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font: var(--font-label);
            font-size: 11px;
            font-weight: var(--font-weight-medium);
        }

        /* Pattern Recognition */
        .pattern-card {
            background: var(--color-surface-tone-2);
            border-radius: var(--radius-large);
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--color-primary);
        }

        .pattern-title {
            font: var(--font-body);
            font-weight: var(--font-weight-medium);
            margin-bottom: 8px;
        }

        .pattern-description {
            font: var(--font-label);
            color: var(--color-on-surface-variant);
            line-height: 1.5;
        }

        .pattern-stat {
            font-weight: var(--font-weight-medium);
            color: var(--color-primary);
        }

        /* Responsive adjustments for analytics */
        @media (max-width: 768px) {
            .analytics-tabs {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }

            .chart-wrapper {
                height: 250px;
            }

            .comparison-table {
                font-size: 12px;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 8px;
            }
        }

    </style>
</head>
<body>
    
    <!-- Auth Screen -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2 class="auth-title">
                <!-- Icon updated to new default -->
                <span class="material-symbols-outlined">task_alt</span>
                Habit Tracker
            </h2>
            <p class="auth-subtitle" id="authSubtitle">Sign in to sync your habits</p>
            
            <form id="authForm">
                <div class="input-group">
                    <label for="email" class="input-label">Email</label>
                    <input type="email" id="email" class="input-field" required autocomplete="email">
                </div>
                <div class="input-group">
                    <label for="password" class="input-label">Password</label>
                    <input type="password" id="password" class="input-field" required autocomplete="current-password">
                </div>
                
                <p class="auth-error" id="authError"></p>
                
                <div class="auth-actions">
                    <button type="button" class="filled-button state-layer-primary" id="authButton" onclick="handleLoginClick()">Sign In</button>
                    <button type="button" class="toggle-auth state-layer-secondary" id="authToggle" onclick="toggleAuthMode()">Need an account? Sign Up</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="app-container" id="appContainer">
        <!-- App Bar -->
        <div class="app-bar" id="appBar">
            <div class="app-bar-content">
                <div>
                    <div class="app-title">
                        <span class="material-symbols-outlined">task_alt</span>
                        Habit Tracker
                    </div>
                    <div class="app-subtitle">Build consistency, one day at a time</div>
                </div>
                <div class="app-bar-actions">
                    <!-- REFINEMENT: Principle #2 - Replace "Synced" with icon -->
                    <div class="sync-status" id="syncStatus" title="Sync Status">
                        <span class="material-symbols-outlined">cloud_done</span>
                    </div>
                    
                    <!-- REFINEMENT: Principle #7 - Add Dark Mode Toggle -->
                    <button class="theme-toggle-button state-layer-on-primary" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
                        <span class="material-symbols-outlined" id="icon-light-mode">light_mode</span>
                        <span class="material-symbols-outlined" id="icon-dark-mode">dark_mode</span>
                    </button>
                    
                    <button class="text-button state-layer-on-primary" onclick="handleSignOut()">Sign Out</button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Setup Banner (for Firebase config) -->
            <div class="setup-banner" id="setupBanner">
                <h3>
                    <span class="material-symbols-outlined">settings</span>
                    Firebase Setup Required
                </h3>
                <p><strong>This app won't work without a Firebase backend.</strong> Follow these steps to enable secure cloud sync:</p>
                <ol>
                    <li>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                    <li>Create a new project (free)</li>
                    <li>Enable <strong>Email/Password Authentication</strong> in Authentication â†’ Sign-in method</li>
                    <li>Create <strong>Firestore Database</strong> in production mode</li>
                    <li>Go to Firestore's <strong>Rules</strong> tab and replace the default rules with the ones from the console warning.</li>
                    <li>Add a Web App (in Project Settings) and copy your config object into the <code>firebaseConfig</code> variable in the code.</li>
                </ol>
                <p style="margin-top: 16px;"><strong>This banner will hide once you add your config.</strong></p>
            </div>

            <!-- Date Card -->
            <div class="date-card">
                <div class="date-header">
                    <div class="current-date" id="currentDate"></div>
                    <div class="date-subtext" id="dateSubtext"></div>
                </div>
                
                <div class="progress-ring-container">
                    <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-bg" cx="60" cy="60" r="52"></circle>
                        <circle 
                            class="progress-ring-circle" 
                            cx="60" 
                            cy="60" 
                            r="52"
                            id="progressCircle"
                            style="stroke: var(--color-primary); stroke-dasharray: 326.73; stroke-dashoffset: 326.73;">
                        </circle>
                    </svg>
                    <div class="progress-text" id="progressText">0/0</div>
                </div>

                <div class="date-nav">
                    <button class="icon-button state-layer-secondary" onclick="changeDate(-1)" aria-label="Previous day">
                        <span class="material-symbols-outlined">chevron_left</span>
                    </button>
                    <button class="today-button state-layer-primary" onclick="goToToday()">
                        <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">today</span>
                        Today
                    </button>
                    <button class="icon-button state-layer-secondary" onclick="changeDate(1)" id="nextDayBtn" aria-label="Next day">
                        <span class="material-symbols-outlined">chevron_right</span>
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <!-- Added style for stagger animation -->
                <div class="stat-card" style="--index: 1;">
                    <!-- REFINEMENT: Principle #2 & 4 - Semantic/Colored Icons -->
                    <div class="stat-icon" id="weekProgressIcon">
                        <span class="material-symbols-outlined">calendar_month</span>
                    </div>
                    <div class="stat-value" id="weekProgress">0%</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card" style="--index: 2;">
                    <div class="stat-icon" id="totalCheckinsIcon">
                        <span class="material-symbols-outlined">task_alt</span>
                    </div>
                    <div class="stat-value" id="totalCheckins">0</div>
                    <div class="stat-label">Total Check-ins</div>
                </div>
                <div class="stat-card" style="--index: 3;">
                    <div class="stat-icon" id="bestStreakIcon">
                        <span class="material-symbols-outlined">local_fire_department</span>
                    </div>
                    <div class="stat-value" id="bestStreak">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div class="stat-card" style="--index: 4;">
                    <div class="stat-icon" id="avgCompletionIcon">
                        <span class="material-symbols-outlined">leaderboard</span>
                    </div>
                    <div class="stat-value" id="avgCompletion">0%</div>
                    <div class="stat-label">Avg Rate</div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="analytics-tabs">
                <button class="analytics-tab active" onclick="switchAnalyticsTab('overview')">
                    <span class="material-symbols-outlined">dashboard</span>
                    Overview
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('heatmap')">
                    <span class="material-symbols-outlined">grid_on</span>
                    Heatmap
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('trends')">
                    <span class="material-symbols-outlined">trending_up</span>
                    Trends
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('insights')">
                    <span class="material-symbols-outlined">lightbulb</span>
                    Insights
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('compare')">
                    <span class="material-symbols-outlined">compare_arrows</span>
                    Compare
                </button>
            </div>

            <!-- Analytics Content Sections -->

            <!-- Overview Tab -->
            <div class="analytics-content active" id="overview-content">
                <div class="analytics-mini-stats">
                    <div class="mini-stat-card">
                        <div class="mini-stat-value" id="miniTotalHabits">0</div>
                        <div class="mini-stat-label">Active Habits</div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-value" id="miniTodayCompleted">0</div>
                        <div class="mini-stat-label">Today Completed</div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-value" id="miniTodayRate">0%</div>
                        <div class="mini-stat-label">Today's Rate</div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-value" id="miniCurrentStreak">0</div>
                        <div class="mini-stat-label">Current Streak</div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-value" id="miniMonthProgress">0%</div>
                        <div class="mini-stat-label">This Month</div>
                    </div>
                    <div class="mini-stat-card">
                        <div class="mini-stat-value" id="miniConsistency">0%</div>
                        <div class="mini-stat-label">Consistency</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">show_chart</span>
                        7-Day Trend
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="sevenDayTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">donut_small</span>
                        Today's Progress
                    </h3>
                    <div class="chart-wrapper small">
                        <canvas id="todayDonutChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">bar_chart</span>
                        Monthly Performance (Last 6 Months)
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="monthlyPerformanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Enhanced Heatmap Tab -->
            <div class="analytics-content" id="heatmap-content">
                <div class="heatmap-filters">
                    <div class="filter-group">
                        <label>Period:</label>
                        <select id="heatmapPeriodFilter" class="filter-select" onchange="updateEnhancedHeatmap()">
                            <option value="3">3 Months</option>
                            <option value="6" selected>6 Months</option>
                            <option value="12">1 Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Habit:</label>
                        <select id="heatmapHabitFilter" class="filter-select" onchange="updateEnhancedHeatmap()">
                            <option value="all">All Habits</option>
                        </select>
                    </div>
                </div>

                <div class="chart-card">
                    <div id="enhancedHeatmapGrid"></div>
                    <div class="heatmap-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--color-surface-tone-3); opacity: 0.25;"></div>
                            <span>0-25%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--color-primary); opacity: 0.5;"></div>
                            <span>26-50%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--color-primary); opacity: 0.75;"></div>
                            <span>51-75%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--color-primary); opacity: 1;"></div>
                            <span>76-100%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div class="analytics-content" id="trends-content">
                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">timeline</span>
                        30-Day Completion Trend
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="thirtyDayTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">local_fire_department</span>
                        Streak Timeline
                    </h3>
                    <div class="chart-wrapper large">
                        <canvas id="streakTimelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="analytics-content" id="insights-content">
                <div class="insights-grid">
                    <div id="topPerformersContainer" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Generated by JS -->
                    </div>

                    <div id="needsAttentionContainer" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">calendar_view_week</span>
                        Best Days of the Week
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="bestDaysChart"></canvas>
                    </div>
                </div>

                <div id="patternRecognitionContainer" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Compare Tab -->
            <div class="analytics-content" id="compare-content">
                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">table_chart</span>
                        Habit Comparison
                    </h3>
                    <table class="comparison-table" id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Habit</th>
                                <th>This Week</th>
                                <th>This Month</th>
                                <th>Current Streak</th>
                                <th>Best Streak</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="chart-card">
                    <h3>
                        <span class="material-symbols-outlined">stacked_line_chart</span>
                        Head-to-Head (Last 14 Days)
                    </h3>
                    <div class="compare-selects" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: center;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Habit 1:</label>
                            <select id="compareHabit1" class="filter-select" style="width: 100%;">
                                <!-- Generated by JS -->
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Habit 2:</label>
                            <select id="compareHabit2" class="filter-select" style="width: 100%;">
                                <!-- Generated by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper large">
                        <canvas id="headToHeadChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Habits Section -->
            <div class="habits-section" id="habitsList">
                 <div class="habits-list-empty-state" id="emptyState">
                    <span class="material-symbols-outlined">add_task</span>
                    <h3>Your habit list is empty</h3>
                    <p>Click the <strong>+</strong> button in the corner to add your first habit!</p>
                </div>
                <!-- Habits will be rendered here by JavaScript -->
            </div>

            <!-- Export Section -->
            <div class="export-section">
                <h3>
                    <!-- REFINEMENT: Principle #6 - Change icon -->
                    <span class="material-symbols-outlined" style="vertical-align: middle;">cloud_download</span>
                    Export Your Data
                </h3>
                <p>Download your complete habit history as a CSV file</p>
                <button class="filled-button state-layer-primary" onclick="exportToCSV()">
                    <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">file_download</span>
                    Download CSV
                </button>
                <!-- REFINEMENT: Principle #6 - Add privacy note -->
                <p class="export-privacy-note">Your data stays privateâ€”exported only to your device.</p>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab state-layer-on-primary" onclick="openHabitModal()" aria-label="Add new habit" id="fabButton">
        <span class="material-symbols-outlined">add</span>
    </button>

    <!-- Celebration Overlay -->
    <div class="celebration" id="celebration">
        <div class="celebration-emoji">ðŸŽ‰</div>
        <div class="celebration-text">All habits completed!</div>
        <div class="celebration-subtext">Keep up the amazing work!</div>
    </div>
    
    <!-- REFINEMENT: Principle 7 - Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- Snackbar -->
    <div class="snackbar" id="snackbar">
        <span class="material-symbols-outlined" id="snackbarIcon">check_circle</span>
        <span id="snackbarText"></span>
    </div>

    <!-- Add/Edit Habit Modal -->
    <div class="modal-overlay" id="habitModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="habitModalTitle">Add New Habit</h3>
                <button class="icon-button state-layer-secondary" onclick="closeHabitModal()" style="box-shadow: none;">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="habitForm">
                    <input type="hidden" id="habitIdInput">
                    
                    <!-- REFINEMENT: Principle 4 - "I will..." -->
                    <div class="form-group">
                        <label for="habitName" class="form-label">I will...</label>
                        <input type="text" id="habitName" class="form-input" placeholder="e.g., Read 10 pages" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="habitIcon" class="form-label">Icon (Emoji)</label>
                        <input type="text" id="habitIcon" class="form-input" placeholder="e.g., ðŸ“š" required>
                    </div>
                    
                    <!-- REFINEMENT: Principle 4 - "so I become..." -->
                    <div class="form-group">
                        <label for="habitWhy" class="form-label">...so I can (Your 'Why' - Optional)</label>
                        <input type="text" id="habitWhy" class="form-input" placeholder="e.g., learn a new skill">
                    </div>
                    
                    <div class="form-group">
                        <label for="habitSchedule" class="form-label">Schedule</label>
                        <select id="habitSchedule" class="form-select">
                            <option value="daily">Daily</option>
                            <option value="weekdays">Weekdays Only (Mon-Fri)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <div class="color-picker" id="colorPicker">
                            <!-- Swatches added by JS -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="outlined-button state-layer-primary" onclick="closeHabitModal()">Cancel</button>
                <button class="filled-button state-layer-primary" onclick="saveHabit()">Save Habit</button>
            </div>
        </div>
    </div>
    
    <!-- Heatmap Modal -->
    <div class="modal-overlay" id="heatmapModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="heatmapTitle">Habit Consistency</h3>
                <button class="icon-button state-layer-secondary" onclick="closeHeatmapModal()" style="box-shadow: none;">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="heatmap-grid" id="heatmapGrid">
                    <!-- Days will be generated by JS -->
                </div>
                <div class="heatmap-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-surface-tone-3);"></div>
                        <span>Less</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--habit-color);" id="heatmapLegendColor"></div>
                        <span>More</span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK (No changes here) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, doc, setDoc, getDoc, onSnapshot, 
            collection, query, getDocs, deleteDoc, writeBatch, 
            addDoc, serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        

        // TODO: Replace with your Firebase config
        // Get this from Firebase Console â†’ Project Settings â†’ Your App                    
        const firebaseConfig = {
            Â  Â  apiKey: "AIzaSyBi8ESQV1hcdr9bG6v-tesiTzscDsGFiyQ",
            Â  Â  authDomain: "habit-tracker-5ad2d.firebaseapp.com",
            Â  Â  projectId: "habit-tracker-5ad2d",
            Â     storageBucket: "habit-tracker-5ad2d.firebasestorage.app",
            Â  Â  messagingSenderId: "704810863965",
            Â  Â  appId: "1:704810863965:web:d63facc167c7de928f2cb4",
            Â  Â  measurementId: "G-SXFYLD0D1C"
            Â  };

        let app, db, auth;
        
        // --- Make key variables global ---
        window.firebaseEnabled = false;
        window.currentUser = null;
        window.db = null;
        window.fb = {
            doc,
            collection,
            writeBatch,
            addDoc,
            setDoc,
            deleteDoc,
            getDoc,
            getDocs,
            query,
            onSnapshot,
            serverTimestamp
        };
        // --- End global variables ---

        // Try to initialize Firebase
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                window.firebaseEnabled = true; // Set flag
                window.db = db; // Expose db
                
                // --- This is now the main controller ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        window.currentUser = user;
                        console.log('Signed in with user ID:', user.uid);
                        
                        // Hide login, show app
                        document.getElementById('authOverlay').classList.remove('show');
                        document.getElementById('appContainer').classList.add('show');
                        
                        // Load all user data
                        window.loadAllData();
                        
                    } else {
                        // User is signed out
                        window.currentUser = null;
                        console.log('User is signed out');
                        
                        // Show login, hide app
                        document.getElementById('authOverlay').classList.add('show');
                        document.getElementById('appContainer').classList.remove('show');
                        
                        // Clear local data to prevent overlap
                        window.clearLocalData();
                    }
                });
                
                console.log('Firebase initialized successfully');
            } else {
                console.log('Firebase not configured. App cannot start.');
                document.getElementById('setupBanner').classList.add('show');
                
                // Show the login screen, but with an error
                document.getElementById('authOverlay').classList.add('show');
                const errorEl = document.getElementById('authError');
                errorEl.textContent = 'Firebase is not configured. Please add your firebaseConfig to index.html.';
                errorEl.style.display = 'block';
                
                // Disable the form
                document.getElementById('authButton').disabled = true;
                document.getElementById('authToggle').disabled = true;
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('setupBanner').classList.add('show');
        }

        // --- Auth Functions ---
        window.handleLoginClick = function() {
            // This function is now shared for Login and Sign Up
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const button = document.getElementById('authButton');
            const errorEl = document.getElementById('authError');
            
            if (!email || password.length < 6) {
                errorEl.textContent = 'Please enter a valid email and a password (min. 6 chars).';
                errorEl.style.display = 'block';
                return;
            }
            
            errorEl.style.display = 'none';
            button.disabled = true;
            
            if (window.isLoginMode) {
                // --- Sign In ---
                button.textContent = 'Signing In...';
                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // Signed in, onAuthStateChanged will handle the rest
                        console.log('User signed in:', userCredential.user.uid);
                    })
                    .catch((error) => {
                        errorEl.textContent = error.message;
                        errorEl.style.display = 'block';
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = 'Sign In';
                    });
            } else {
                // --- Sign Up ---
                button.textContent = 'Creating Account...';
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // Signed up, onAuthStateChanged will handle the rest
                        console.log('User created:', userCredential.user.uid);
                    })
                    .catch((error) => {
                        errorEl.textContent = error.message;
                        errorEl.style.display = 'block';
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = 'Sign Up';
                    });
            }
        }
        
        window.handleSignOut = function() {
            signOut(auth).catch((error) => {
                console.error('Sign out error:', error);
            });
        }
        
        window.isLoginMode = true;
        window.toggleAuthMode = function() {
            window.isLoginMode = !window.isLoginMode;
            const button = document.getElementById('authButton');
            const toggle = document.getElementById('authToggle');
            const subtitle = document.getElementById('authSubtitle');
            
            if (window.isLoginMode) {
                button.textContent = 'Sign In';
                toggle.textContent = 'Need an account? Sign Up';
                subtitle.textContent = 'Sign in to sync your habits';
            } else {
                button.textContent = 'Sign Up';
                toggle.textContent = 'Have an account? Sign In';
                subtitle.textContent = 'Create an account to get started';
            }
            document.getElementById('authError').style.display = 'none';
        }

    </script>

    <script>
        // === GLOBAL APP STATE ===
        let habitData = {}; // { "2025-11-06": { "habitId1": true } }
        let habits = [];    // [ { id: "...", name: "...", icon: "..." } ]
        let currentViewDate = new Date();
        
        const habitSuggestions = [
            { name: "Read 10 pages", icon: "ðŸ“š", why: "become more knowledgeable" },
            { name: "Go for a walk", icon: "ðŸš¶", why: "improve my health" },
            { name: "Drink 8 glasses of water", icon: "ðŸ’§", why: "stay hydrated" },
            { name: "Meditate for 5 minutes", icon: "ðŸ§˜", why: "clear my mind" },
            { name: "Write in a journal", icon: "âœï¸", why: "practice gratitude" },
            { name: "No social media before 9 AM", icon: "ðŸ“±", why: "start the day focused" },
            { name: "Practice a new skill", icon: "ðŸ’¡", why: "grow my abilities" },
        ];
        
        // REFINEMENT: Principle #8 - Motivational Quotes
        const motivationalQuotes = [
            "The secret of getting ahead is getting started.",
            "Don't break the chain.",
            "A little progress each day adds up to big results.",
            "Consistency is what transforms average into excellence.",
            "You don't have to be great to start, but you have to start to be great.",
            "Motivation is what gets you started. Habit is what keeps you going."
        ];
        let todayQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
        
        // Colors from your principles
        const habitColors = [
            '#EA4335', '#FBBC04', '#34A853', '#1A73E8', '#673AB7',
            '#E91E63', '#009688', '#FF9800', '#607D8B', '#795548'
        ];

        // === UTILITY FUNCTIONS ===
        
        function getUserId() {
            if (window.currentUser) {
                return window.currentUser.uid;
            }
            return null;
        }

        function getDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function showSnackbar(message, isError = false) {
            const snackbar = document.getElementById('snackbar');
            const icon = document.getElementById('snackbarIcon');
            
            document.getElementById('snackbarText').textContent = message;
            
            if (isError) {
                icon.textContent = 'error';
                icon.style.color = 'var(--color-error)';
            } else {
                icon.textContent = 'check_circle';
                icon.style.color = 'var(--color-success)';
            }
            
            snackbar.classList.add('show');
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }
        
        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            if (!syncStatus) return;
            const icon = syncStatus.querySelector('.material-symbols-outlined');
            
            if (status === 'syncing') {
                syncStatus.classList.add('syncing');
                icon.textContent = 'sync';
                syncStatus.title = 'Syncing...';
            } else if (status === 'synced') {
                syncStatus.classList.remove('syncing');
                icon.textContent = 'cloud_done';
                syncStatus.title = 'Synced';
            } else if (status === 'error') {
                syncStatus.classList.remove('syncing');
                icon.textContent = 'cloud_off';
                syncStatus.title = 'Sync Error';
            }
        }
        
        function clearAllData() {
            habits = [];
            habitData = {};
            currentViewDate = new Date();
            window.renderHabits();
            window.updateDisplay();
        }
        
        window.clearLocalData = function() {
            // Called on sign-out
            habits = [];
            habitData = {};
            localStorage.removeItem('habitTrackerHabits');
            localStorage.removeItem('habitTrackerData');
            window.renderHabits();
            window.updateDisplay();
        }
        
        function isWeekday(date) {
            const day = date.getDay();
            return day >= 1 && day <= 5; // Monday=1, Friday=5
        }

        // === DATA LOADING & SAVING ===

        window.loadAllData = async function() {
            // This is the main entry point after login
            const userId = getUserId();
            if (!userId) return;
            
            try {
                // 1. Load habits config
                await window.loadHabits();
                
                // 2. Load habit data (check-ins)
                await window.loadHabitData();
                
                // 3. Setup realtime listeners
                window.setupRealtimeSync();
                
                // 4. Update UI
                window.renderHabits();
                window.updateDisplay();
                
            } catch (error) {
                console.error("Error loading all data:", error);
                showSnackbar("Error loading data. Please refresh.", true);
            }
        }

        window.loadHabits = async function() {
            // Load the list of habits (name, icon, etc.)
            const userId = getUserId();
            if (!userId) return;

            // Try local cache first
            const localHabits = localStorage.getItem('habitTrackerHabits');
            if (localHabits) {
                habits = JSON.parse(localHabits);
                window.renderHabits(); // Render quickly from cache
            }

            if (window.firebaseEnabled) {
                try {
                    console.log('Loading habits from Firebase...');
                    // Path: /users/{userId}/userHabits/{habitDocId}
                    const q = window.fb.query(window.fb.collection(window.db, 'users', userId, 'userHabits'));
                    const querySnapshot = await window.fb.getDocs(q);
                    
                    if (querySnapshot.empty && habits.length === 0) {
                        // User has no habits and no local habits.
                        console.log('No habits found. User is new.');
                        habits = [];
                    } else if (!querySnapshot.empty) {
                        let newHabits = [];
                        querySnapshot.forEach((doc) => {
                            newHabits.push({ id: doc.id, ...doc.data() });
                        });
                        habits = newHabits;
                        console.log('Habits loaded from Firebase:', habits);
                    }
                    
                    // Save to local storage and render
                    window.saveHabitsLocal();
                    window.renderHabits();
                    
                } catch (error) {
                    console.error("Error loading habits from Firebase:", error);
                    showSnackbar("Error loading your habits.", true);
                    // Print the security rules message
                    console.warn(
                        "Firestore Security Rules error. Make sure you have the following rules in your Firebase Console -> Firestore -> Rules:\n" +
                        `
                        rules_version = '2';
                        service cloud.firestore {
                          match /databases/{database}/documents {
                            // Allow users to read/write their own data
                            match /users/{userId}/{document=**} {
                              allow read, write: if request.auth != null && request.auth.uid == userId;
                            }
                          }
                        }
                        `
                    );
                }
            }
        }
        
        window.loadHabitData = async function() {
            // Load the check-in data (dates)
            const userId = getUserId();
            if (!userId) return;

            // Try local cache first
            const localData = localStorage.getItem('habitTrackerData');
            if (localData) {
                habitData = JSON.parse(localData);
                window.updateDisplay(); // Render quickly
            }

            if (window.firebaseEnabled) {
                try {
                    console.log('Loading habit data from Firebase...');
                    // Path: /users/{userId}/habitData/{dateString}
                    const q = window.fb.query(window.fb.collection(window.db, 'users', userId, 'habitData'));
                    const querySnapshot = await window.fb.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            habitData[doc.id] = doc.data();
                        });
                        console.log('Habit data loaded from Firebase');
                    }
                    
                    window.saveHabitDataLocal();
                    window.updateDisplay();
                    
                } catch (error) {
                    console.error("Error loading from Firebase:", error);
                }
            }
        }
        
        window.saveHabitsLocal = function() {
            // Sort by creation time before saving
            habits.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            localStorage.setItem('habitTrackerHabits', JSON.stringify(habits));
        }
        
        window.saveHabitDataLocal = function() {
            localStorage.setItem('habitTrackerData', JSON.stringify(habitData));
        }

        // === REALTIME SYNC ===

        window.setupRealtimeSync = function() {
            const userId = getUserId();
            if (!window.firebaseEnabled || !userId) {
                return;
            }

            // 1. Listen for changes to the list of habits
            try {
                const habitsRef = window.fb.collection(window.db, 'users', userId, 'userHabits');
                window.fb.onSnapshot(habitsRef, (snapshot) => {
                    let newHabits = [];
                    snapshot.forEach(doc => {
                        newHabits.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort by creation time
                    newHabits.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    habits = newHabits;
                    
                    window.saveHabitsLocal();
                    window.renderHabits();
                    window.updateDisplay();
                    console.log('Realtime: Habits list synced.');
                });
            } catch (error) {
                console.error("Error setting up habits listener:", error);
            }

            // 2. Listen for changes to the check-in data
            try {
                const dataRef = window.fb.collection(window.db, 'users', userId, 'habitData');
                window.fb.onSnapshot(dataRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const dateStr = change.doc.id;
                            const data = change.doc.data();
                            habitData[dateStr] = data;
                            console.log(`Realtime: Synced data for ${dateStr}`);
                        }
                        // Note: Deletions not handled, as we don't delete date docs
                    });
                    window.saveHabitDataLocal();
                    window.updateDisplay();
                });
            } catch (error) {
                console.error("Error setting up habit data listener:", error);
            }
        }
        
        // === HABIT CRUD FUNCTIONS ===
        
        window.openHabitModal = function(habitId = null) {
            const modal = document.getElementById('habitModal');
            const title = document.getElementById('habitModalTitle');
            const form = document.getElementById('habitForm');
            
            // Reset form
            form.reset();
            document.getElementById('habitIdInput').value = '';
            
            // Clear existing 'selected' swatches
            document.querySelectorAll('.color-swatch.selected').forEach(sw => sw.classList.remove('selected'));
            
            if (habitId) {
                // --- Edit Mode ---
                const habit = habits.find(h => h.id === habitId);
                if (habit) {
                    title.textContent = 'Edit Habit';
                    document.getElementById('habitIdInput').value = habit.id;
                    document.getElementById('habitName').value = habit.name;
                    document.getElementById('habitIcon').value = habit.icon;
                    document.getElementById('habitSchedule').value = habit.schedule;
                    document.getElementById('habitWhy').value = habit.why || '';
                    
                    // Select color
                    const swatch = document.querySelector(`.color-swatch[data-color="${habit.color}"]`);
                    if (swatch) {
                        swatch.classList.add('selected');
                    }
                }
            } else {
                // --- Add Mode ---
                title.textContent = 'Add New Habit';
                
                // Set a suggestion
                const suggestion = habitSuggestions[Math.floor(Math.random() * habitSuggestions.length)];
                document.getElementById('habitName').value = suggestion.name;
                document.getElementById('habitIcon').value = suggestion.icon;
                document.getElementById('habitWhy').value = suggestion.why || '';
                
                // Select first color by default
                document.querySelector('.color-swatch').classList.add('selected');
            }
            
            modal.classList.add('show');
        }
        
        window.closeHabitModal = function() {
            document.getElementById('habitModal').classList.remove('show');
        }
        
        window.saveHabit = async function() {
            const userId = getUserId();
            if (!userId) return;
            
            const id = document.getElementById('habitIdInput').value;
            const name = document.getElementById('habitName').value;
            const icon = document.getElementById('habitIcon').value;
            const schedule = document.getElementById('habitSchedule').value;
            const why = document.getElementById('habitWhy').value; // Get the "why"
            const selectedColor = document.querySelector('.color-swatch.selected');
            
            if (!name || !icon || !selectedColor) {
                showSnackbar("Please fill out all fields.", true);
                return;
            }
            
            const color = selectedColor.dataset.color;
            
            const habitData = {
                name,
                icon,
                schedule,
                color,
                why: why || '', // Save the "why"
                createdAt: window.fb.serverTimestamp() // Add/update server timestamp
            };
            
            if (id) {
                // --- Update existing habit ---
                try {
                    const habitRef = window.fb.doc(window.db, 'users', userId, 'userHabits', id);
                    await window.fb.setDoc(habitRef, habitData, { merge: true }); // Use setDoc with merge
                    showSnackbar("Habit updated!");
                } catch (error) {
                    console.error("Error updating habit:", error);
                    showSnackbar("Error updating habit.", true);
                }
            } else {
                // --- Add new habit ---
                try {
                    const habitRef = window.fb.collection(window.db, 'users', userId, 'userHabits');
                    await window.fb.addDoc(habitRef, habitData);
                    showSnackbar("Habit added!");
                } catch (error) {
                    console.error("Error adding habit:", error);
                    showSnackbar("Error adding habit.", true);
                }
            }
            
            closeHabitModal();
            // Realtime listener will handle the UI update
        }
        
        window.deleteHabit = async function(habitId, habitName) {
            const userId = getUserId();
            if (!userId) return;

            if (!confirm(`Are you sure you want to delete "${habitName}"?\n\nThis will NOT delete your past check-in history for this habit.`)) {
                return;
            }
            
            try {
                const habitRef = window.fb.doc(window.db, 'users', userId, 'userHabits', habitId);
                await window.fb.deleteDoc(habitRef);
                showSnackbar("Habit deleted!");
            } catch (error) {
                console.error("Error deleting habit:", error);
                showSnackbar("Error deleting habit.", true);
            }
            // Realtime listener will handle UI update
        }

        // === MAIN APP LOGIC ===
        
        window.renderHabits = function() {
            const list = document.getElementById('habitsList');
            if (!list) return;
            
            // Clear list but preserve empty state
            const emptyState = document.getElementById('emptyState');
            list.innerHTML = '';
            list.appendChild(emptyState);

            if (habits.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            habits.forEach(habit => {
                const scheduleText = habit.schedule === 'weekdays' ? 'Weekdays' : 'Daily';
                
                const card = document.createElement('div');
                card.className = 'habit-card';
                card.style = `--habit-color: ${habit.color};`;
                card.id = `card-${habit.id}`; // Add ID for flash animation
                
                card.onclick = (e) => openHeatmapModal(e, habit.id, habit.name, habit.color);
                
                let whyHtml = habit.why ? `<div class="habit-why">...so I can ${habit.why}</div>` : '';
                
                card.innerHTML = `
                    <div class="habit-checkbox-wrapper">
                        <input type="checkbox" class="habit-checkbox" id="habit-${habit.id}" data-habit-id="${habit.id}">
                    </div>
                    <div class="habit-icon">${habit.icon}</div>
                    <div class="habit-content">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-schedule">${scheduleText}</div>
                        ${whyHtml}
                    </div>
                    <div class="habit-menu dropdown">
                        <button class="icon-button state-layer-secondary" onclick="toggleDropdown(event, '${habit.id}')">
                            <span class="material-symbols-outlined">more_vert</span>
                        </button>
                        <div class="dropdown-content" id="dropdown-${habit.id}">
                            <button class="dropdown-item state-layer-secondary" onclick="openHabitModal('${habit.id}')">
                                <span class="material-symbols-outlined">edit</span>
                                Edit
                            </button>
                            <button class="dropdown-item delete state-layer-secondary" onclick="deleteHabit('${habit.id}', '${habit.name.replace(/'/g, "\\'")}')">
                                <span class="material-symbols-outlined">delete</span>
                                Delete
                            </button>
                        </div>
                    </div>
                    <!-- REFINEMENT: Principle 3 - Progress Bar -->
                    <div class="habit-progress-bar-container">
                        <div class="habit-progress-bar" id="progress-${habit.id}" style="background-color: ${habit.color};"></div>
                    </div>
                `;
                
                list.appendChild(card);
                
                // Add event listener to checkbox
                card.querySelector('.habit-checkbox').addEventListener('click', function(e) {
                    e.stopPropagation(); // Stop card click
                    updateHabitData(this.dataset.habitId);
                });
            });
            
            // After rendering, update progress bars
            updateAllProgressBars();
        }
        
        window.toggleDropdown = function(event, habitId) {
            event.stopPropagation(); // Prevent card click
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-content.show').forEach(openDropdown => {
                if (openDropdown.id !== `dropdown-${habitId}`) {
                    openDropdown.classList.remove('show');
                }
            });
            
            // Toggle the clicked one
            const dropdown = document.getElementById(`dropdown-${habitId}`);
            dropdown.classList.toggle('show');
        }
        
        // Close dropdowns if clicking outside
        window.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content.show').forEach(openDropdown => {
                    openDropdown.classList.remove('show');
                });
            }
        });


        window.updateHabitData = async function(habitId) {
            const dateStr = getDateString(currentViewDate);
            const checkbox = document.getElementById(`habit-${habitId}`);
            
            // Get current data for the day
            let dayData = habitData[dateStr] || {};
            
            // Update the specific habit
            dayData[habitId] = checkbox.checked;
            
            // Put it back into the main data object
            habitData[dateStr] = dayData;
            
            // Save locally
            window.saveHabitDataLocal();
            
            // --- REFINEMENTS: Principle 1 & 7 ---
            // 1. Pop the progress ring
            const ring = document.querySelector('.progress-ring-container');
            if (ring) {
                ring.classList.add('pop');
                ring.addEventListener('animationend', () => ring.classList.remove('pop'), { once: true });
            }
            
            // 2. Flash the habit card
            const card = document.getElementById(`card-${habitId}`);
            if (card && checkbox.checked) { // Only flash on completion
                card.classList.add('flash');
                card.addEventListener('animationend', () => card.classList.remove('flash'), { once: true });
            }
            // --- End Refinements ---
            
            // Save to Firebase
            const userId = getUserId();
            if (window.firebaseEnabled && userId) {
                try {
                    updateSyncStatus('syncing');
                    // Path: /users/{userId}/habitData/{dateString}
                    const dateRef = window.fb.doc(window.db, 'users', userId, 'habitData', dateStr);
                    await window.fb.setDoc(dateRef, dayData, { merge: true }); // Use setDoc with merge
                    updateSyncStatus('synced');
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    updateSyncStatus('error');
                }
            }
            
            window.updateDisplay();
            checkForCelebration();
        }

        window.checkForCelebration = function() {
            const dateStr = getDateString(currentViewDate);
            const today = getDateString(new Date());
            
            if (dateStr !== today) return;
            
            const dayData = habitData[dateStr] || {};
            let allComplete = habits.length > 0; // Assume complete, then check
            
            for (const habit of habits) {
                const isApplicable = !(habit.schedule === 'weekdays' && !isWeekday(currentViewDate));
                if (isApplicable && !dayData[habit.id]) {
                    allComplete = false;
                    break;
                }
            }
            
            if (allComplete) {
                showCelebration();
            }
        }

        function showCelebration() {
            const celebration = document.getElementById('celebration');
            celebration.classList.add('show');
            
            // REFINEMENT: Principle 7 - Run Confetti
            runCelebrationConfetti();
            
            setTimeout(() => {
                celebration.classList.remove('show');
            }, 3000);
        }
        
        // REFINEMENT: Principle 7 - Confetti Function
        function runCelebrationConfetti() {
            const container = document.getElementById('confettiContainer');
            container.innerHTML = ''; // Clear old confetti
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = habitColors[Math.floor(Math.random() * habitColors.length)];
                confetti.style.animationDuration = `${2 + Math.random() * 2}s`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                container.appendChild(confetti);
            }
            
            // Clear confetti elements after animation
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        window.updateDisplay = function() {
            const dateStr = getDateString(currentViewDate);
            const today = getDateString(new Date());
            
            // Update date display
            const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            document.getElementById('currentDate').textContent = currentViewDate.toLocaleDateString('en-US', options);
            
            // Disable next day button for future dates
            document.getElementById('nextDayBtn').disabled = dateStr >= today;
            
            // Update checkboxes and habit cards
            const dayData = habitData[dateStr] || {};
            let todayComplete = 0;
            let totalHabitsToday = 0;
            
            habits.forEach(habit => {
                const checkbox = document.getElementById(`habit-${habit.id}`);
                if (!checkbox) return; // Habit may not be rendered yet
                
                const habitCard = checkbox.closest('.habit-card');
                const isApplicable = !(habit.schedule === 'weekdays' && !isWeekday(currentViewDate));
                
                if (isApplicable) {
                    checkbox.disabled = false;
                    checkbox.checked = dayData[habit.id] || false;
                    habitCard.style.opacity = '1';
                    totalHabitsToday++;
                    
                    if (checkbox.checked) {
                        todayComplete++;
                        habitCard.classList.add('completed');
                    } else {
                        habitCard.classList.remove('completed');
                    }
                } else {
                    // Not applicable (e.g., weekday habit on weekend)
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    habitCard.style.opacity = '0.5';
                    habitCard.classList.remove('completed');
                }
            });
            
            // --- REFINEMENT: Principle #3 - Microcopy Feedback ---
            const subtextEl = document.getElementById('dateSubtext');
            if (dateStr === today) {
                if (totalHabitsToday === 0) {
                    subtextEl.textContent = "Add a habit to get started!";
                } else if (todayComplete === 0) {
                    subtextEl.textContent = todayQuote; // Show quote
                } else if (todayComplete === 1 && totalHabitsToday > 1) {
                    subtextEl.textContent = "You're off to a great start!";
                } else if (todayComplete > 1 && todayComplete < totalHabitsToday) {
                    subtextEl.textContent = "Keep up the great work!";
                } else if (todayComplete === totalHabitsToday) {
                    subtextEl.textContent = "All done! You crushed it today! ðŸŽ‰";
                }
            } else if (dateStr < today) {
                subtextEl.textContent = 'Past day - Reviewing your progress';
            } else {
                subtextEl.textContent = 'Future day - Plan ahead!';
            }
            // --- End Refinement ---
            
            // Update progress ring
            updateProgressRing(todayComplete, totalHabitsToday);
            
            // Update stats
            document.getElementById('weekProgress').textContent = calculateWeekProgress() + '%';
            document.getElementById('totalCheckins').textContent = calculateTotalCheckins();
            document.getElementById('bestStreak').textContent = calculateBestStreak();
            document.getElementById('avgCompletion').textContent = calculateAvgCompletion() + '%';
            
            // REFINEMENT: Principle 3 - Update all progress bars
            updateAllProgressBars();
        }
        
        // REFINEMENT: Principle 3 - Function to update all bars
        function updateAllProgressBars() {
            habits.forEach(habit => {
                const rate = calculateCompletionRate(habit.id);
                const progressBar = document.getElementById(`progress-${habit.id}`);
                if (progressBar) {
                    progressBar.style.width = `${rate}%`;
                }
            });
        }

        function updateProgressRing(completed, total) {
            const circle = document.getElementById('progressCircle');
            const text = document.getElementById('progressText');
            if (!circle || !text) return;
            
            const radius = 52;
            const circumference = 2 * Math.PI * radius;
            
            const progress = total > 0 ? (completed / total) : 0;
            const offset = circumference - (progress * circumference);
            
            circle.style.strokeDashoffset = offset;
            text.textContent = `${completed}/${total}`;
        }
        
        function getOldestDataDate() {
            const dates = Object.keys(habitData);
            if (dates.length === 0) {
                return new Date();
            }
            dates.sort();
            return new Date(dates[0]);
        }

        function calculateStreak(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            let streak = 0;
            let checkDate = new Date();
            
            for (let i = 0; i < 365; i++) { // Check up to 1 year back
                const isApplicable = !(habit.schedule === 'weekdays' && !isWeekday(checkDate));
                const dateStr = getDateString(checkDate);
                const dayData = habitData[dateStr] || {};

                if (isApplicable) {
                    if (dayData[habit.id]) {
                        streak++;
                    } else if (i > 0) {
                        // Missed an applicable day that wasn't today
                        break;
                    } else if (i === 0 && !dayData[habit.id]) {
                        // Not done today, streak is 0
                    }
                }
                // If not applicable, streak continues
                
                checkDate.setDate(checkDate.getDate() - 1);
            }

            return streak;
        }

        function calculateCompletionRate(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            const startDate = getOldestDataDate();
            const today = new Date();
            let totalDays = 0;
            let completedDays = 0;
            
            let checkDate = new Date(startDate);
            while (checkDate <= today) {
                const isApplicable = !(habit.schedule === 'weekdays' && !isWeekday(checkDate));
                
                if (isApplicable) {
                    totalDays++;
                    const dateStr = getDateString(checkDate);
                    const dayData = habitData[dateStr] || {};
                    if (dayData[habit.id]) {
                        completedDays++;
                    }
                }
                
                checkDate.setDate(checkDate.getDate() + 1);
            }
            
            return totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;
        }

        function calculateWeekProgress() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay()); // Get last Sunday
            
            let totalPossible = 0;
            let totalCompleted = 0;
            
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(weekStart);
                checkDate.setDate(weekStart.getDate() + i);
                
                if (checkDate > today) break;
                
                const dateStr = getDateString(checkDate);
                const dayData = habitData[dateStr] || {};
                
                habits.forEach(habit => {
                    const isApplicable = !(habit.schedule === 'weekdays' && !isWeekday(checkDate));
                    if (isApplicable) {
                        totalPossible++;
                        if (dayData[habit.id]) {
                            totalCompleted++;
                        }
                    }
                });
            }
            
            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }

        function calculateTotalCheckins() {
            let total = 0;
            Object.values(habitData).forEach(dayData => {
                Object.values(dayData).forEach(checked => {
                    if (checked) total++;
                });
            });
            return total;
        }

        function calculateBestStreak() {
            // This is a placeholder. A real "best streak" requires iterating all time.
            // For now, return the best "current" streak.
            let bestStreak = 0;
            habits.forEach(habit => {
                const streak = calculateStreak(habit.id);
                if (streak > bestStreak) {
                    bestStreak = streak;
                }
            });
            return bestStreak;
        }

        function calculateAvgCompletion() {
            if (habits.length === 0) return 0;
            let total = 0;
            
            habits.forEach(habit => {
                total += calculateCompletionRate(habit.id);
            });
            
            return Math.round(total / habits.length);
        }

        window.changeDate = function(days) {
            currentViewDate.setDate(currentViewDate.getDate() + days);
            window.updateDisplay();
        }

        window.goToToday = function() {
            currentViewDate = new Date();
            window.updateDisplay();
            showSnackbar('Back to today! ðŸ“…');
        }

        window.exportToCSV = function() {
            let csv = 'Date,';
            habits.forEach(habit => {
                csv += `"${habit.name.replace(/"/g, '""')}",`;
            });
            csv = csv.slice(0, -1) + '\n'; // Remove last comma
            
            const startDate = getOldestDataDate();
            const endDate = new Date();
            
            let checkDate = new Date(startDate);
            while (checkDate <= endDate) {
                const dateStr = getDateString(checkDate);
                const dayData = habitData[dateStr] || {};
                
                csv += `${dateStr},`;
                habits.forEach(habit => {
                    csv += `${dayData[habit.id] ? 'Yes' : 'No'},`;
                });
                csv = csv.slice(0, -1) + '\n';
                
                checkDate.setDate(checkDate.getDate() + 1);
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-${getDateString(new Date())}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSnackbar('CSV downloaded successfully! ðŸ’¾');
        }
        
        // === HEATMAP LOGIC ===
        
        window.openHeatmapModal = function(event, habitId, habitName, habitColor) {
            // Stop if clicking checkbox or menu
            if (event.target.matches('.habit-checkbox') || event.target.closest('.habit-menu')) {
                return;
            }
            
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            document.getElementById('heatmapTitle').textContent = `${habit.icon} ${habit.name}`;
            
            // Update legend color
            document.getElementById('heatmapLegendColor').style.backgroundColor = habitColor;
            
            // Generate grid
            generateHeatmapGrid(habit);
            
            // Show modal
            document.getElementById('heatmapModal').classList.add('show');
        }
        
        window.closeHeatmapModal = function() {
            document.getElementById('heatmapModal').classList.remove('show');
        }
        
        window.generateHeatmapGrid = function(habit) {
            const grid = document.getElementById('heatmapGrid');
            grid.innerHTML = '';
            
            const numWeeks = 26; // 6 months
            const today = new Date();
            
            // Find the Sunday of this week
            let startDate = new Date();
            startDate.setDate(today.getDate() - today.getDay());
            
            // Go back numWeeks
            startDate.setDate(startDate.getDate() - (numWeeks - 1) * 7);
            
            let checkDate = new Date(startDate);
            
            for (let i = 0; i < numWeeks * 7; i++) {
                const day = document.createElement('div');
                day.className = 'heatmap-day';
                
                const dateStr = getDateString(checkDate);
                
                if (checkDate > today) {
                    day.classList.add('na'); // Future date
                } else {
                    const dayData = habitData[dateStr] || {};
                    const isApplicable = !(habit.schedule === 'weekdays' && !isWeekday(checkDate));
                    
                    if (!isApplicable) {
                        day.classList.add('na'); // Not applicable
                    } else if (dayData[habit.id]) {
                        day.classList.add('filled'); // Completed
                        day.style.backgroundColor = habit.color;
                    } else {
                        day.classList.add('missed'); // Missed
                    }
                }
                
                if (dateStr === getDateString(today)) {
                    day.classList.add('today');
                }
                
                day.title = checkDate.toLocaleDateString();
                grid.appendChild(day);
                
                checkDate.setDate(checkDate.getDate() + 1);
            }
        }
        
        
        // === INITIALIZE ===
        
        function populateColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = ''; // Clear first
            habitColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.dataset.color = color;
                swatch.style.backgroundColor = color;
                swatch.onclick = () => {
                    document.querySelectorAll('.color-swatch.selected').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                };
                picker.appendChild(swatch);
            });
        }
        
        // REFINEMENT: Principle #2 - Dynamic App Bar
        window.addEventListener('scroll', () => {
            const appBar = document.getElementById('appBar');
            if (!appBar) return;
            if (window.scrollY > 10) {
                appBar.classList.add('scrolled');
            } else {
                appBar.classList.remove('scrolled');
            }
        });
        
        // REFINEMENT: Principle #7 - Dark Mode Toggle
        window.toggleDarkMode = function() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            
            // Save preference
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        }
        
        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            // Check for saved theme OR system preference
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        // Initialize on page load
        function init() {
            // Auth is handled by onAuthStateChanged
            applyInitialTheme();
            populateColorPicker();
            goToToday(); // Sets initial date and calls updateDisplay
        }
        
        // ==========================================
        // ANALYTICS FUNCTIONS
        // ==========================================

        // Chart instances (global to allow updates)
        let sevenDayTrendChart = null;
        let todayDonutChart = null;
        let monthlyPerformanceChart = null;
        let thirtyDayTrendChart = null;
        let streakTimelineChart = null;
        let bestDaysChart = null;
        let headToHeadChart = null;

        // Current analytics tab
        let currentAnalyticsTab = 'overview';

        /**
         * Switch between analytics tabs
         */
        function switchAnalyticsTab(tabName) {
            currentAnalyticsTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.analytics-tab').classList.add('active');

            // Update content sections
            document.querySelectorAll('.analytics-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');

            // Refresh data for the selected tab
            updateAnalyticsTab(tabName);
        }

        /**
         * Update analytics for a specific tab
         */
        function updateAnalyticsTab(tabName) {
            switch(tabName) {
                case 'overview':
                    updateOverviewTab();
                    break;
                case 'heatmap':
                    updateEnhancedHeatmap();
                    break;
                case 'trends':
                    updateTrendsTab();
                    break;
                case 'insights':
                    updateInsightsTab();
                    break;
                case 'compare':
                    updateCompareTab();
                    break;
            }
        }

        /**
         * Calculate best streak for a habit (all time)
         */
        function calculateBestStreakAllTime(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            let maxStreak = 0;
            let currentStreak = 0;

            // Get all dates from oldest data to today
            const startDate = getOldestDataDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayData = habitData[dateStr] || {};

                if (dayData[habitId]) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }

            return maxStreak;
        }

        /**
         * Calculate current month progress percentage
         */
        function calculateMonthProgress() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();

            let totalPossible = 0;
            let totalCompleted = 0;

            habits.forEach(habit => {
                for (let day = 1; day <= today; day++) {
                    const dateStr = new Date(year, month, day).toISOString().split('T')[0];
                    totalPossible++;
                    if (habitData[dateStr] && habitData[dateStr][habit.id]) {
                        totalCompleted++;
                    }
                }
            });

            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }

        /**
         * Calculate consistency score (0-100) based on completion patterns
         */
        function calculateConsistencyScore() {
            if (habits.length === 0) return 0;

            const last30Days = [];
            const today = new Date();

            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last30Days.push(date.toISOString().split('T')[0]);
            }

            let totalScore = 0;

            habits.forEach(habit => {
                let completedDays = 0;
                last30Days.forEach(dateStr => {
                    if (habitData[dateStr] && habitData[dateStr][habit.id]) {
                        completedDays++;
                    }
                });
                totalScore += (completedDays / 30) * 100;
            });

            return Math.round(totalScore / habits.length);
        }

        /**
         * Get day of week analysis
         */
        function getDayOfWeekData() {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            const dayTotals = [0, 0, 0, 0, 0, 0, 0];

            const last90Days = [];
            const today = new Date();

            for (let i = 0; i < 90; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last90Days.push(date);
            }

            habits.forEach(habit => {
                last90Days.forEach(date => {
                    const dayOfWeek = date.getDay();
                    const dateStr = date.toISOString().split('T')[0];
                    dayTotals[dayOfWeek]++;
                    if (habitData[dateStr] && habitData[dateStr][habit.id]) {
                        dayCounts[dayOfWeek]++;
                    }
                });
            });

            const percentages = dayCounts.map((count, index) =>
                dayTotals[index] > 0 ? Math.round((count / dayTotals[index]) * 100) : 0
            );

            return { dayNames, percentages };
        }

        /**
         * Calculate completion rate for a habit over specified days
         */
        function calculatePeriodRate(habitId, days) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            let completed = 0;
            const today = new Date();

            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                if (habitData[dateStr] && habitData[dateStr][habit.id]) {
                    completed++;
                }
            }

            return Math.round((completed / days) * 100);
        }

        /**
         * Update Overview Tab
         */
        function updateOverviewTab() {
            // Mini stats
            const activeHabits = habits.length;
            const todayDateStr = getDateString(new Date());
            const todayCompleted = habits.filter(h => habitData[todayDateStr] && habitData[todayDateStr][h.id]).length;
            const todayRate = activeHabits > 0 ? Math.round((todayCompleted / activeHabits) * 100) : 0;
            const currentStreak = calculateCurrentStreak();
            const monthProgress = calculateMonthProgress();
            const consistencyScore = calculateConsistencyScore();

            document.getElementById('miniTotalHabits').textContent = activeHabits;
            document.getElementById('miniTodayCompleted').textContent = todayCompleted;
            document.getElementById('miniTodayRate').textContent = `${todayRate}%`;
            document.getElementById('miniCurrentStreak').textContent = currentStreak;
            document.getElementById('miniMonthProgress').textContent = `${monthProgress}%`;
            document.getElementById('miniConsistency').textContent = `${consistencyScore}%`;

            // Initialize charts
            initSevenDayTrendChart();
            initTodayDonutChart();
            initMonthlyPerformanceChart();
        }

        /**
         * Calculate current streak (consecutive days with at least one habit completed)
         */
        function calculateCurrentStreak() {
            if (habits.length === 0) return 0;

            let streak = 0;
            const today = new Date();

            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                let dayHasCompletion = false;
                for (const habit of habits) {
                    if (habitData[dateStr] && habitData[dateStr][habit.id]) {
                        dayHasCompletion = true;
                        break;
                    }
                }

                if (dayHasCompletion) {
                    streak++;
                } else {
                    break;
                }
            }

            return streak;
        }

        /**
         * Initialize 7-Day Trend Chart
         */
        function initSevenDayTrendChart() {
            const ctx = document.getElementById('sevenDayTrendChart');
            if (!ctx) return;

            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                let dayCompleted = 0;
                habits.forEach(habit => {
                    if (habitData[dateStr] && habitData[dateStr][habit.id]) {
                        dayCompleted++;
                    }
                });

                data.push(dayCompleted);
            }

            if (sevenDayTrendChart) {
                sevenDayTrendChart.destroy();
            }

            sevenDayTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Habits Completed',
                        data: data,
                        borderColor: 'rgb(103, 80, 164)',
                        backgroundColor: 'rgba(103, 80, 164, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: 'rgb(103, 80, 164)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        /**
         * Initialize Today's Completion Donut Chart
         */
        function initTodayDonutChart() {
            const ctx = document.getElementById('todayDonutChart');
            if (!ctx) return;

            const completed = habits.filter(h => h.completions && h.completions[todayDate]).length;
            const pending = habits.length - completed;

            if (todayDonutChart) {
                todayDonutChart.destroy();
            }

            todayDonutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completed, pending],
                        backgroundColor: ['rgb(103, 80, 164)', 'rgba(103, 80, 164, 0.2)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        /**
         * Initialize Monthly Performance Chart (6 months)
         */
        function initMonthlyPerformanceChart() {
            const ctx = document.getElementById('monthlyPerformanceChart');
            if (!ctx) return;

            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                labels.push(date.toLocaleDateString('en-US', { month: 'short' }));

                const year = date.getFullYear();
                const month = date.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let monthTotal = 0;
                let monthCompleted = 0;

                habits.forEach(habit => {
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = new Date(year, month, day).toISOString().split('T')[0];
                        monthTotal++;
                        if (habit.completions && habit.completions[dateStr]) {
                            monthCompleted++;
                        }
                    }
                });

                const percentage = monthTotal > 0 ? Math.round((monthCompleted / monthTotal) * 100) : 0;
                data.push(percentage);
            }

            if (monthlyPerformanceChart) {
                monthlyPerformanceChart.destroy();
            }

            monthlyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completion %',
                        data: data,
                        backgroundColor: 'rgb(103, 80, 164)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Update Enhanced Heatmap
         */
        function updateEnhancedHeatmap() {
            const periodFilter = document.getElementById('heatmapPeriodFilter').value;
            const habitFilter = document.getElementById('heatmapHabitFilter').value;
            const grid = document.getElementById('enhancedHeatmapGrid');

            if (!grid) return;

            // Update habit filter dropdown
            const habitSelect = document.getElementById('heatmapHabitFilter');
            habitSelect.innerHTML = '<option value="all">All Habits</option>';
            habits.forEach(habit => {
                const option = document.createElement('option');
                option.value = habit.id;
                option.textContent = habit.name;
                habitSelect.appendChild(option);
            });

            // Calculate date range
            const months = parseInt(periodFilter);
            const today = new Date();
            const startDate = new Date(today);
            startDate.setMonth(startDate.getMonth() - months);

            // Generate heatmap
            grid.innerHTML = '';

            // Month labels
            const monthLabels = document.createElement('div');
            monthLabels.className = 'heatmap-month-labels';

            for (let m = 0; m < months; m++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() - (months - m - 1));
                const label = document.createElement('div');
                label.textContent = date.toLocaleDateString('en-US', { month: 'short' });
                monthLabels.appendChild(label);
            }

            grid.appendChild(monthLabels);

            // Day labels
            const dayLabels = document.createElement('div');
            dayLabels.className = 'heatmap-day-labels';
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                const label = document.createElement('div');
                label.textContent = day;
                dayLabels.appendChild(label);
            });
            grid.appendChild(dayLabels);

            // Days grid
            const daysGrid = document.createElement('div');
            daysGrid.className = 'heatmap-days-grid';

            const totalDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));

            for (let i = totalDays; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                let completedCount = 0;
                let totalCount = 0;

                if (habitFilter === 'all') {
                    totalCount = habits.length;
                    habits.forEach(habit => {
                        if (habit.completions && habit.completions[dateStr]) {
                            completedCount++;
                        }
                    });
                } else {
                    const habit = habits.find(h => h.id === habitFilter);
                    if (habit) {
                        totalCount = 1;
                        if (habit.completions && habit.completions[dateStr]) {
                            completedCount = 1;
                        }
                    }
                }

                const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

                const dayEl = document.createElement('div');
                dayEl.className = 'enhanced-heatmap-day';

                if (percentage === 0) {
                    dayEl.style.background = 'var(--color-surface-tone-3)';
                } else if (percentage <= 25) {
                    dayEl.style.background = 'rgba(103, 80, 164, 0.25)';
                } else if (percentage <= 50) {
                    dayEl.style.background = 'rgba(103, 80, 164, 0.5)';
                } else if (percentage <= 75) {
                    dayEl.style.background = 'rgba(103, 80, 164, 0.75)';
                } else {
                    dayEl.style.background = 'rgb(103, 80, 164)';
                }

                // Tooltip
                dayEl.title = `${date.toLocaleDateString()}: ${completedCount}/${totalCount} (${Math.round(percentage)}%)`;

                daysGrid.appendChild(dayEl);
            }

            grid.appendChild(daysGrid);
        }

        /**
         * Update Trends Tab
         */
        function updateTrendsTab() {
            initThirtyDayTrendChart();
            initStreakTimelineChart();
        }

        /**
         * Initialize 30-Day Completion Trend Chart
         */
        function initThirtyDayTrendChart() {
            const ctx = document.getElementById('thirtyDayTrendChart');
            if (!ctx) return;

            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                if (i % 5 === 0) {
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                } else {
                    labels.push('');
                }

                let dayCompleted = 0;
                habits.forEach(habit => {
                    if (habit.completions && habit.completions[dateStr]) {
                        dayCompleted++;
                    }
                });

                const percentage = habits.length > 0 ? Math.round((dayCompleted / habits.length) * 100) : 0;
                data.push(percentage);
            }

            if (thirtyDayTrendChart) {
                thirtyDayTrendChart.destroy();
            }

            thirtyDayTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completion %',
                        data: data,
                        borderColor: 'rgb(103, 80, 164)',
                        backgroundColor: 'rgba(103, 80, 164, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: 'rgb(103, 80, 164)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Initialize Streak Timeline Chart
         */
        function initStreakTimelineChart() {
            const ctx = document.getElementById('streakTimelineChart');
            if (!ctx) return;

            const labels = [];
            const currentStreaks = [];
            const bestStreaks = [];

            habits.slice(0, 8).forEach(habit => {
                labels.push(habit.name.length > 15 ? habit.name.substring(0, 15) + '...' : habit.name);

                // Calculate current streak
                let currentStreak = 0;
                const today = new Date();
                for (let i = 0; i < 365; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    if (habit.completions && habit.completions[dateStr]) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
                currentStreaks.push(currentStreak);

                // Calculate best streak
                const bestStreak = calculateBestStreakAllTime(habit.id);
                bestStreaks.push(bestStreak);
            });

            if (streakTimelineChart) {
                streakTimelineChart.destroy();
            }

            streakTimelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Current Streak',
                            data: currentStreaks,
                            backgroundColor: 'rgb(103, 80, 164)',
                            borderRadius: 6
                        },
                        {
                            label: 'Best Streak',
                            data: bestStreaks,
                            backgroundColor: 'rgba(103, 80, 164, 0.4)',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        /**
         * Update Insights Tab
         */
        function updateInsightsTab() {
            generateTopPerformers();
            generateNeedsAttention();
            initBestDaysChart();
            generatePatternRecognition();
        }

        /**
         * Generate Top Performers
         */
        function generateTopPerformers() {
            const container = document.getElementById('topPerformersContainer');
            if (!container) return;

            container.innerHTML = '';

            if (habits.length === 0) {
                container.innerHTML = '<p style="color: var(--color-on-surface-variant); text-align: center;">No habits tracked yet</p>';
                return;
            }

            // Calculate 30-day completion rates
            const habitScores = habits.map(habit => {
                const rate = calculatePeriodRate(habit.id, 30);
                return { habit, rate };
            });

            // Sort by rate
            habitScores.sort((a, b) => b.rate - a.rate);

            // Top 3
            habitScores.slice(0, 3).forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'insight-card';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span class="material-symbols-outlined" style="font-size: 32px; color: ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : '#CD7F32'};">
                            ${index === 0 ? 'workspace_premium' : 'emoji_events'}
                        </span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 16px;">${item.habit.name}</div>
                            <div style="color: var(--color-on-surface-variant); font-size: 14px;">30-day completion: ${item.rate}%</div>
                        </div>
                    </div>
                    <div style="background: var(--color-surface-tone-3); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: rgb(103, 80, 164); height: 100%; width: ${item.rate}%; transition: width 0.3s;"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        /**
         * Generate Needs Attention List
         */
        function generateNeedsAttention() {
            const container = document.getElementById('needsAttentionContainer');
            if (!container) return;

            container.innerHTML = '';

            if (habits.length === 0) {
                container.innerHTML = '<p style="color: var(--color-on-surface-variant); text-align: center;">No habits tracked yet</p>';
                return;
            }

            // Calculate 7-day completion rates
            const habitScores = habits.map(habit => {
                const rate = calculatePeriodRate(habit.id, 7);
                return { habit, rate };
            });

            // Sort by rate (ascending)
            habitScores.sort((a, b) => a.rate - b.rate);

            // Bottom 3
            habitScores.slice(0, 3).forEach(item => {
                const card = document.createElement('div');
                card.className = 'insight-card';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span class="material-symbols-outlined" style="font-size: 32px; color: var(--color-error);">
                            error
                        </span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 16px;">${item.habit.name}</div>
                            <div style="color: var(--color-on-surface-variant); font-size: 14px;">Only ${item.rate}% completion this week</div>
                        </div>
                    </div>
                    <div style="background: var(--color-surface-tone-3); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: var(--color-error); height: 100%; width: ${item.rate}%; transition: width 0.3s;"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        /**
         * Initialize Best Days Chart
         */
        function initBestDaysChart() {
            const ctx = document.getElementById('bestDaysChart');
            if (!ctx) return;

            const { dayNames, percentages } = getDayOfWeekData();

            if (bestDaysChart) {
                bestDaysChart.destroy();
            }

            bestDaysChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: 'Completion %',
                        data: percentages,
                        backgroundColor: 'rgb(103, 80, 164)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Generate Pattern Recognition
         */
        function generatePatternRecognition() {
            const container = document.getElementById('patternRecognitionContainer');
            if (!container) return;

            container.innerHTML = '';

            if (habits.length === 0) {
                container.innerHTML = '<p style="color: var(--color-on-surface-variant); text-align: center;">No habits tracked yet</p>';
                return;
            }

            const { dayNames, percentages } = getDayOfWeekData();

            // Find best and worst days
            const maxIndex = percentages.indexOf(Math.max(...percentages));
            const minIndex = percentages.indexOf(Math.min(...percentages));

            // Best day pattern
            const bestCard = document.createElement('div');
            bestCard.className = 'insight-card';
            bestCard.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="material-symbols-outlined" style="font-size: 32px; color: rgb(103, 80, 164);">
                        trending_up
                    </span>
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">Best Day</div>
                        <div style="color: var(--color-on-surface-variant); font-size: 14px;">
                            ${dayNames[maxIndex]} - ${percentages[maxIndex]}% completion rate
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(bestCard);

            // Worst day pattern
            const worstCard = document.createElement('div');
            worstCard.className = 'insight-card';
            worstCard.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="material-symbols-outlined" style="font-size: 32px; color: var(--color-error);">
                        trending_down
                    </span>
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">Needs Improvement</div>
                        <div style="color: var(--color-on-surface-variant); font-size: 14px;">
                            ${dayNames[minIndex]} - ${percentages[minIndex]}% completion rate
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(worstCard);

            // Consistency pattern
            const consistencyScore = calculateConsistencyScore();
            const consistencyCard = document.createElement('div');
            consistencyCard.className = 'insight-card';
            const consistencyLevel = consistencyScore >= 80 ? 'Excellent' : consistencyScore >= 60 ? 'Good' : consistencyScore >= 40 ? 'Fair' : 'Needs Work';
            const consistencyColor = consistencyScore >= 80 ? 'rgb(103, 80, 164)' : consistencyScore >= 60 ? '#4CAF50' : consistencyScore >= 40 ? '#FF9800' : 'var(--color-error)';

            consistencyCard.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="material-symbols-outlined" style="font-size: 32px; color: ${consistencyColor};">
                        insights
                    </span>
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">Consistency Level</div>
                        <div style="color: var(--color-on-surface-variant); font-size: 14px;">
                            ${consistencyLevel} - ${consistencyScore}% over last 30 days
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(consistencyCard);
        }

        /**
         * Update Compare Tab
         */
        function updateCompareTab() {
            populateComparisonTable();
            initHeadToHeadChart();
        }

        /**
         * Populate Comparison Table
         */
        function populateComparisonTable() {
            const tbody = document.querySelector('#comparisonTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            habits.forEach(habit => {
                const rate7 = calculatePeriodRate(habit.id, 7);
                const rate30 = calculatePeriodRate(habit.id, 30);
                const bestStreak = calculateBestStreakAllTime(habit.id);

                // Current streak
                let currentStreak = 0;
                const today = new Date();
                for (let i = 0; i < 365; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    if (habit.completions && habit.completions[dateStr]) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${habit.name}</td>
                    <td>${rate7}%</td>
                    <td>${rate30}%</td>
                    <td>${currentStreak}</td>
                    <td>${bestStreak}</td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Initialize Head-to-Head Comparison Chart
         */
        function initHeadToHeadChart() {
            const ctx = document.getElementById('headToHeadChart');
            if (!ctx) return;

            const select1 = document.getElementById('compareHabit1');
            const select2 = document.getElementById('compareHabit2');

            // Populate selects
            select1.innerHTML = '';
            select2.innerHTML = '';

            habits.forEach((habit, index) => {
                const option1 = document.createElement('option');
                option1.value = habit.id;
                option1.textContent = habit.name;
                if (index === 0) option1.selected = true;
                select1.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = habit.id;
                option2.textContent = habit.name;
                if (index === 1 || (index === 0 && habits.length === 1)) option2.selected = true;
                select2.appendChild(option2);
            });

            // Draw chart
            drawHeadToHeadChart();
        }

        /**
         * Draw Head-to-Head Chart
         */
        function drawHeadToHeadChart() {
            const ctx = document.getElementById('headToHeadChart');
            if (!ctx) return;

            const select1 = document.getElementById('compareHabit1');
            const select2 = document.getElementById('compareHabit2');

            const habit1 = habits.find(h => h.id === select1.value);
            const habit2 = habits.find(h => h.id === select2.value);

            if (!habit1 || !habit2) return;

            const labels = [];
            const data1 = [];
            const data2 = [];
            const today = new Date();

            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                data1.push(habit1.completions && habit1.completions[dateStr] ? 1 : 0);
                data2.push(habit2.completions && habit2.completions[dateStr] ? 1 : 0);
            }

            if (headToHeadChart) {
                headToHeadChart.destroy();
            }

            headToHeadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: habit1.name,
                            data: data1,
                            borderColor: 'rgb(103, 80, 164)',
                            backgroundColor: 'rgba(103, 80, 164, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(103, 80, 164)'
                        },
                        {
                            label: habit2.name,
                            data: data2,
                            borderColor: 'rgb(233, 30, 99)',
                            backgroundColor: 'rgba(233, 30, 99, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(233, 30, 99)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value === 1 ? 'Done' : 'Not Done';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Update all analytics
         */
        function updateAllAnalytics() {
            if (currentAnalyticsTab) {
                updateAnalyticsTab(currentAnalyticsTab);
            }
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', function() {
            const heatmapPeriodFilter = document.getElementById('heatmapPeriodFilter');
            const heatmapHabitFilter = document.getElementById('heatmapHabitFilter');
            const compareHabit1 = document.getElementById('compareHabit1');
            const compareHabit2 = document.getElementById('compareHabit2');

            if (heatmapPeriodFilter) {
                heatmapPeriodFilter.addEventListener('change', updateEnhancedHeatmap);
            }
            if (heatmapHabitFilter) {
                heatmapHabitFilter.addEventListener('change', updateEnhancedHeatmap);
            }
            if (compareHabit1) {
                compareHabit1.addEventListener('change', drawHeadToHeadChart);
            }
            if (compareHabit2) {
                compareHabit2.addEventListener('change', drawHeadToHeadChart);
            }
        });

        init();

    </script>
</body>
</html>
