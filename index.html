<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker - Material You</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;
            --md-sys-color-background: #FEF7FF;
            --md-sys-color-on-background: #1D1B20;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            --md-sys-color-inverse-surface: #322F35;
            --md-sys-color-inverse-on-surface: #F5EFF7;
            --md-sys-color-inverse-primary: #D0BCFF;
            --md-sys-color-surface-1: #F6EDFF;
            --md-sys-color-surface-2: #F2E9FC;
            --md-sys-color-surface-3: #EEE5F9;
            --md-sys-color-surface-4: #ECE3F7;
            --md-sys-color-surface-5: #E9E0F5;
            
            /* Color presets for habits */
            --color-preset-1: #FF6B6B;
            --color-preset-2: #4ECDC4;
            --color-preset-3: #FFD93D;
            --color-preset-4: #B565D8;
            --color-preset-5: #6C5CE7;
            --color-preset-6: #48DBFB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            min-height: 100vh;
            /* Prevent scrolling when login modal is open */
            overflow: hidden;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* App Bar */
        .app-bar {
            background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, var(--md-sys-color-tertiary) 100%);
            color: var(--md-sys-color-on-primary);
            padding: 24px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .app-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px; /* Added gap for new button */
        }

        .app-bar-left {
            flex-grow: 1;
        }

        .app-title {
            font-size: 28px;
            font-weight: 500;
            letter-spacing: 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        } /* <--- CSS FIX: Added missing closing brace */

        .app-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 13px;
            backdrop-filter: blur(10px);
        }

        .sync-status.syncing {
            background: rgba(255,255,255,0.3);
        }

        .sync-status.syncing .material-symbols-rounded {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sign Out Button */
        .sign-out-btn {
            background: rgba(255,255,255,0.2);
            color: var(--md-sys-color-on-primary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sign-out-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: scale(1.05);
        }

        /* Utility Class */
        .hidden {
            display: none !important;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        } /* <--- CSS FIX: Added missing closing brace */

        /* Setup Banner */
        .setup-banner {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: none;
            animation: slideIn 0.5s ease-out;
            color: white;
        }

        .setup-banner.show {
            display: block;
        }

        .setup-banner h3 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-banner p {
            font-size: 14px;
            margin-bottom: 16px;
            opacity: 0.95;
        }

        .setup-banner code {
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .setup-banner ol {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .setup-banner li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        /* Date Card */
        .date-card {
            background: var(--md-sys-color-surface-1);
            border-radius: 28px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .date-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-date {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 8px;
        }

        .date-subtext {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .date-nav {
            display: flex;
            justify-content: center;
            gap: 12px;
            align-items: center;
        }

        .icon-button {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .icon-button:hover {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: scale(1.05);
        }

        .icon-button:active {
            transform: scale(0.95);
        }

        .icon-button:disabled {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-outline);
            cursor: not-allowed;
            transform: none;
        }

        .today-button {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }

        .today-button:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }

        .today-button:active {
            transform: translateY(0);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--md-sys-color-surface-2);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 8px;
            color: var(--md-sys-color-primary);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Habits List */
        .habits-section {
            background: var(--md-sys-color-surface-1);
            border-radius: 28px;
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            /* This will now be populated by JS */
            min-height: 100px;
        }

        .habit-card {
            background: var(--md-sys-color-surface);
            border-radius: 20px;
            padding: 20px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .habit-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--habit-color);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .habit-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }

        .habit-card:hover::before {
            width: 8px;
        }

        .habit-card.completed {
            background: var(--md-sys-color-primary-container);
        }

        .habit-card.completed::before {
            width: 8px;
        }

        /* Custom Checkbox */
        .habit-checkbox-wrapper {
            position: relative;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }

        .habit-checkbox {
            appearance: none;
            width: 28px;
            height: 28px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--md-sys-color-surface);
        }

        .habit-checkbox:checked {
            background: var(--habit-color);
            border-color: var(--habit-color);
        }

        .habit-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 18px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(1);
            animation: checkPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes checkPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .habit-checkbox:hover {
            border-color: var(--habit-color);
            box-shadow: 0 0 0 8px rgba(103, 80, 164, 0.1);
        }

        .habit-checkbox:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .habit-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .habit-content {
            flex: 1;
            min-width: 0;
        }

        .habit-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .habit-schedule {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .habit-stats-inline {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .habit-stat-chip {
            background: var(--md-sys-color-surface-3);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .streak-badge {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* New Habit Menu */
        .habit-menu {
            position: relative;
            margin-left: auto;
        }
        
        .habit-menu-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .habit-menu-btn:hover {
            background: var(--md-sys-color-surface-3);
        }

        .habit-menu-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--md-sys-color-surface-2);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 160px;
            z-index: 10;
            padding: 8px;
            display: none;
            animation: fadeIn 0.1s ease-out;
        }
        
        .habit-menu-dropdown.show {
            display: block;
        }

        .habit-menu-dropdown button {
            background: transparent;
            border: none;
            padding: 12px 16px;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }
        
        .habit-menu-dropdown button:hover {
            background: var(--md-sys-color-surface-3);
        }
        
        .habit-menu-dropdown button.delete {
            color: var(--md-sys-color-error);
        }
        
        .habit-menu-dropdown button.delete:hover {
            background: var(--md-sys-color-error-container);
        }
        
        /* Export Section */
        .export-section {
            background: var(--md-sys-color-surface-2);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .export-section h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--md-sys-color-on-surface);
        }

        .export-section p {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 16px;
        }

        /* Progress Ring */
        .progress-ring-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 20px auto;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--md-sys-color-surface-variant);
            stroke-width: 8;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
        }

        /* Celebrations */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 32px;
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            animation: celebrationPop 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
        }

        .celebration.show {
            display: block;
        }

        @keyframes celebrationPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .celebration-emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .celebration-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .celebration-subtext {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--md-sys-color-background);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .login-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .login-box {
            background: var(--md-sys-color-surface-1);
            border-radius: 28px;
            padding: 32px 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) both;
            border: 1px solid var(--md-sys-color-surface-3);
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 8px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            text-align: center;
            margin-bottom: 24px;
        }
        
        .login-error {
            font-size: 13px;
            color: var(--md-sys-color-error);
            background: var(--md-sys-color-error-container);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
            display: none; /* Hidden by default */
        }

        .login-error.show {
            display: block;
        }
        
        .form-toggle {
            display: flex;
            background: var(--md-sys-color-surface-3);
            border-radius: 20px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* Modal Styles (for Add/Edit and Delete) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-box {
            background: var(--md-sys-color-surface-1);
            border-radius: 28px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) both;
            border: 1px solid var(--md-sys-color-surface-3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 24px;
        }
        
        .modal-body {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            display: block;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 4px var(--md-sys-color-primary-container);
        }

        .color-picker {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .color-radio {
            display: none;
        }
        
        .color-label {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--md-sys-color-surface-1);
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .color-radio:checked + .color-label {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px var(--md-sys-color-primary);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .filled-button {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }

        .filled-button:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        
        .filled-button.delete {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }
        
        .filled-button.delete:hover {
            background: #a11a14;
        }

        .outlined-button {
            background: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.5px;
        }

        .outlined-button:hover {
            background: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .date-nav {
                flex-direction: column;
            }

            .today-button {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .habit-stats-inline {
                flex-direction: column;
                gap: 8px;
            }
            
            .app-bar-content {
                flex-direction: row; /* Keep horizontal */
                align-items: center;
            }

            .app-bar-left {
                max-width: calc(100% - 120px); /* Give space for buttons */
            }

            .app-title {
                 font-size: 20px;
                 margin-bottom: 0;
            }
            .app-subtitle {
                display: none; /* Hide subtitle on small screens */
            }
        }

        /* Fab Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--md-sys-color-inverse-surface);
            color: var(--md-sys-color-inverse-on-surface);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .snackbar.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- App Bar -->
    <div class="app-bar">
        <div class="app-bar-content">
            <div class="app-bar-left">
                <div class="app-title">
                    <span class="material-symbols-rounded">task_alt</span>
                    Habit Tracker
                </div>
                <div class="app-subtitle">Build consistency, one day at a time</div>
            </div>
            <div class="app-bar-right">
                <div class="sync-status" id="syncStatus">
                    <span class="material-symbols-rounded">cloud_done</span>
                    <span id="syncText">Synced</span>
                </div>
                <button class="sign-out-btn" id="signOutBtn" onclick="window.handleSignOut()" aria-label="Sign Out">
                    <span class="material-symbols-rounded">logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Wrapper (Hidden by default) -->
    <div id="appWrapper" class="hidden">
        <div class="container">
            <!-- Setup Banner -->
            <div class="setup-banner" id="setupBanner">
                <h3>
                    <span class="material-symbols-rounded">settings</span>
                    Firebase Setup Required
                </h3>
                <p><strong>Follow these steps to enable secure cloud sync:</strong></p>
                <ol>
                    <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color: white; text-decoration: underline;">Firebase Console</a></li>
                    <li>Create a new project (free)</li>
                    <li>Enable <strong>Email/Password</strong> & <strong>Anonymous</strong> Authentication</li>
                    <li>Create <strong>Firestore Database</strong> in production mode</li>
                    <li>Set security rules (see setup guide)</li>
                    <li>Add Web App and copy your config into the code</li>
                </ol>
                <p style="margin-top: 16px;"><strong>NOTE: This app will use local storage only until Firebase is set up.</strong></p>
                <button class="filled-button" onclick="dismissSetup()">I'll Set This Up Later</button>
            </div>

            <!-- HTML FIX: Restored Date Card content -->
            <div class="date-card">
                <div class="date-header">
                    <div class="current-date" id="currentDate"></div>
                    <div class="date-subtext" id="dateSubtext"></div>
                </div>
                
                <!-- Progress Ring -->
                <div class="progress-ring-container">
                    <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-bg" cx="60" cy="60" r="52"></circle>
                        <circle 
                            class="progress-ring-circle" 
                            cx="60" 
                            cy="60" 
                            r="52"
                            id="progressCircle"
                            style="stroke: var(--md-sys-color-primary); stroke-dasharray: 326.73; stroke-dashoffset: 326.73;">
                        </circle>
                    </svg>
                    <div class="progress-text" id="progressText">0/0</div>
                </div>

                <div class="date-nav">
                    <button class="icon-button" onclick="changeDate(-1)" aria-label="Previous day">
                        <span class="material-symbols-rounded">chevron_left</span>
                    </button>
                    <button class="today-button" onclick="goToToday()">
                        <span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">today</span>
                        Today
                    </button>
                    <button class="icon-button" onclick="changeDate(1)" id="nextDayBtn" aria-label="Next day">
                        <span class="material-symbols-rounded">chevron_right</span>
                    </button>
                </div>
            </div>

            <!-- HTML FIX: Restored Stats Grid content -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ðŸ“…</div>
                    <div class="stat-value" id="weekProgress">0%</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âœ¨</div>
                    <div class="stat-value" id="totalCheckins">0</div>
                    <div class="stat-label">Total Check-ins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ”¥</div>
                    <div class="stat-value" id="bestStreak">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸŽ¯</div>
                    <div class="stat-value" id="avgCompletion">0%</div>
                    <div class="stat-label">Avg Rate</div>
                </div>
            </div>

            <!-- Habits Section (Now Dynamic) -->
            <div class="habits-section" id="habitsList">
                <!-- Habit cards will be injected here by renderHabits() -->
            </div>

            <!-- HTML FIX: Restored Export Section content -->
            <div class="export-section">
                <h3>
                    <span class="material-symbols-rounded" style="vertical-align: middle;">download</span>
                    Export Your Data
                </h3>
                <p>Download your complete habit history as a CSV file</p>
                <button class="filled-button" onclick="exportToCSV()">
                    <span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">file_download</span>
                    Download CSV
                </button>
            </div>
        </div>

        <!-- FAB (Now for Add Habit) -->
        <button class="fab" onclick="openHabitModal(null)" aria-label="Add new habit">
            <span class="material-symbols-rounded">add</span>
        </button>

        <!-- HTML FIX: Restored Celebration Overlay content -->
        <div class="celebration" id="celebration">
            <div class="celebration-emoji">ðŸŽ‰</div>
            <div class="celebration-text">All habits completed!</div>
            <div class="celebration-subtext">Keep up the amazing work!</div>
        </div>
    </div> <!-- End of #appWrapper -->

    <!-- Snackbar -->
    <div class="snackbar" id="snackbar">
        <span class="material-symbols-rounded">check_circle</span>
        <span id="snackbarText"></span>
    </div>

    <!-- HTML FIX: Restored Add/Edit Habit Modal content -->
    <div class="modal-overlay" id="habitModal">
        <div class="modal-box">
            <h3 class="modal-title" id="modalTitle">Add New Habit</h3>
            
            <input type="hidden" id="habitIdInput">
            
            <div class="form-group">
                <label for="habitNameInput" class="form-label">Habit Name</label>
                <input type="text" id="habitNameInput" class="form-input" placeholder="e.g., Read for 20 minutes">
            </div>
            
            <div class="form-group">
                <label for="habitIconInput" class="form-label">Icon (Emoji)</label>
                <input type="text" id="habitIconInput" class="form-input" placeholder="e.g., ðŸ“š" maxlength="2">
            </div>

            <div class="form-group">
                <label for="habitScheduleInput" class="form-label">Schedule</label>
                <select id="habitScheduleInput" class="form-input">
                    <option value="daily">Daily</option>
                    <option value="weekdays">Weekdays Only</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="color-picker">
                    <input type="radio" id="color-1" name="habitColor" class="color-radio" value="var(--color-preset-1)" checked>
                    <label for="color-1" class="color-label" style="background: var(--color-preset-1);"></label>
                    
                    <input type="radio" id="color-2" name="habitColor" class="color-radio" value="var(--color-preset-2)">
                    <label for="color-2" class="color-label" style="background: var(--color-preset-2);"></label>
                    
                    <input type="radio" id="color-3" name="habitColor" class="color-radio" value="var(--color-preset-3)">
                    <label for="color-3" class="color-label" style="background: var(--color-preset-3);"></label>
                    
                    <input type="radio" id="color-4" name="habitColor" class="color-radio" value="var(--color-preset-4)">
                    <label for="color-4" class="color-label" style="background: var(--color-preset-4);"></label>
                    
                    <input type="radio" id="color-5" name="habitColor" class="color-radio" value="var(--color-preset-5)">
                    <label for="color-5" class="color-label" style="background: var(--color-preset-5);"></label>
                    
                    <input type="radio" id="color-6" name="habitColor" class="color-radio" value="var(--color-preset-6)">
                    <label for="color-6" class="color-label" style="background: var(--color-preset-6);"></label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="outlined-button" onclick="closeHabitModal()">Cancel</button>
                <button class="filled-button" onclick="saveHabit()">Save Habit</button>
            </div>
        </div>
    </div>
    
    <!-- HTML FIX: Restored Delete Confirmation Modal content -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <h3 class="modal-title">Delete Habit</h3>
            <div class="modal-body" id="deleteModalText">
                Are you sure you want to delete this habit? This action cannot be undone.
            </div>
            <div class="modal-actions">
                <button class="outlined-button" onclick="closeDeleteConfirm()">Cancel</button>
                <button class="filled-button delete" id="confirmDeleteBtn" onclick="confirmDeleteHabit()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Login/Register Modal (Visible by default) -->
    <div class="login-overlay show" id="loginOverlay">
        <div class="login-box">
            <h3 class="login-title">
                <span class="material-symbols-rounded">task_alt</span>
                Habit Tracker
            </h3>
            <p class="login-subtitle">Sign in to sync your habits</p>
            
            <div class="form-toggle">
                <button id="toggleLogin" class="toggle-btn active" onclick="showLoginTab()">Login</button>
                <button id="toggleRegister" class="toggle-btn" onclick="showRegisterTab()">Register</button>
            </div>
            
            <div class="login-error" id="authError"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="modal-actions" style="justify-content: center;">
                    <button class="filled-button" style="width: 100%;" onclick="handleLoginClick()">Login</button>
                </div>
            </div>
            
            <!-- Register Form (Hidden) -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerEmail" class="form-label">Email</label>
                    <input type="email" id="registerEmail" class="form-input" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword" class="form-label">Password (6+ characters)</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="modal-actions" style="justify-content: center;">
                    <button class="filled-button" style="width: 100%;" onclick="handleRegisterClick()">Create Account</button>
                </div>
            </div>

        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, getDocs, addDoc, updateDoc, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBi8ESQV1hcdr9bG6v-tesiTzscDsGFiyQ",
            authDomain: "habit-tracker-5ad2d.firebaseapp.com",
            projectId: "habit-tracker-5ad2d",
            storageBucket: "habit-tracker-5ad2d.firebasestorage.app",
            messagingSenderId: "704810863965",
            appId: "1:704810863965:web:d63facc167c7de928f2cb4",
            measurementId: "G-SXFYLD0D1C"
        };

        let app, db, auth;
        window.firebaseEnabled = false; 
        let currentUser = null;

        // Try to initialize Firebase
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.firebaseEnabled = true; // Set flag
                
                // --- This is now the main controller ---
                onAuthStateChanged(auth, (user) => {
                    const appWrapper = document.getElementById('appWrapper');
                    const loginOverlay = document.getElementById('loginOverlay');

                    if (user) {
                        // User is signed in
                        currentUser = user;
                        console.log('Signed in with user ID:', user.uid);
                        
                        // Hide login, show app
                        appWrapper.classList.remove('hidden');
                        loginOverlay.classList.remove('show');
                        document.body.style.overflow = 'auto'; // Re-enable scrolling

                        loadAllData(); // Load user's data
                        
                    } else {
                        // User is signed out
                        currentUser = null;
                        console.log('User is signed out.');

                        // Show login, hide app
                        appWrapper.classList.add('hidden');
                        loginOverlay.classList.add('show');
                        document.body.style.overflow = 'hidden'; // Disable scrolling

                        // Clear all data from UI
                        window.habits = [];
                        window.habitData = {};
                        if(window.renderHabits) window.renderHabits();
                        if(window.updateDisplay) window.updateDisplay();
                    }
                });
                
                console.log('Firebase initialized successfully');
            } else {
                // Firebase not configured
                console.log('Firebase not configured, using localStorage only');
                document.getElementById('setupBanner').classList.add('show');
                // Hide login, show app for local-only mode
                document.getElementById('appWrapper').classList.remove('hidden');
                document.getElementById('loginOverlay').classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        } catch (error) {
             console.error('Firebase initialization error:', error);
             document.getElementById('setupBanner').classList.add('show');
             // Hide login, show app for local-only mode
             document.getElementById('appWrapper').classList.remove('hidden');
             document.getElementById('loginOverlay').classList.remove('show');
             document.body.style.overflow = 'auto';
        }
        
        async function loadAllData() {
            await window.loadHabits(); // Load habits list first
            await window.loadFromFirebase(); // Load check-in data
            window.renderHabits();
            window.updateDisplay();
            window.setupRealtimeSync();
        }

        // --- New Auth Functions ---
        window.handleRegister = async (email, password) => {
            if (!window.firebaseEnabled) return;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                showAuthError(error.message);
            }
        };
        
        window.handleLogin = async (email, password) => {
            if (!window.firebaseEnabled) return;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                showAuthError(error.message);
            }
        };

        window.handleSignOut = async () => {
            if (!window.firebaseEnabled) return;
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Sign out error:', error);
                window.showSnackbar('Error signing out.');
            }
        };

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            // Clean up Firebase error codes
            message = message.replace('Firebase: ', '').replace(` (auth/weak-password).`, '.');
            message = message.replace(` (auth/email-already-in-use).`, '.');
            message = message.replace(` (auth/invalid-credential).`, '.');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        window.clearAuthError = () => {
             document.getElementById('authError').classList.remove('show');
        }

        // --- Firestore Data Functions ---
        window.saveToFirebase = async function(dateStr, data) {
            if (!window.firebaseEnabled || !window.getUserId()) return; // <-- FIX
            try {
                updateSyncStatus('syncing');
                const userId = window.getUserId(); // <-- FIX
                await setDoc(doc(db, 'users', userId, 'dates', dateStr), data); // Changed path
                updateSyncStatus('synced');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                updateSyncStatus('error');
            }
        };

        window.loadFromFirebase = async function() {
            if (!window.firebaseEnabled || !window.getUserId()) return null; // <-- FIX
            try {
                const userId = window.getUserId(); // <-- FIX
                const datesRef = collection(db, 'users', userId, 'dates'); // Changed path
                const q = query(datesRef);
                const querySnapshot = await getDocs(q);
                
                const data = {};
                querySnapshot.forEach((doc) => {
                    data[doc.id] = doc.data();
                });
                
                window.habitData = data; // Overwrite local data with cloud data on login
                window.saveData(); // Save fresh data to local
                
                return data;
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                return null;
            }
        };

        window.loadHabitsFromFirebase = async () => {
             if (!window.firebaseEnabled || !window.getUserId()) return null; // <-- FIX
            try {
                const userId = window.getUserId(); // <-- FIX
                const habitsRef = collection(db, 'users', userId, 'userHabits'); // Changed path
                const q = query(habitsRef);
                const querySnapshot = await getDocs(q);
                
                const habits = [];
                querySnapshot.forEach((doc) => {
                    habits.push({ id: doc.id, ...doc.data() });
                });
                return habits;
            } catch (error) {
                console.error('Error loading habits from Firebase:', error);
                return null;
            }
        };
        
        window.addHabitToFirebase = async (habit) => {
             if (!window.firebaseEnabled || !window.getUserId()) return null; // <-- FIX
            try {
                const userId = window.getUserId(); // <-- FIX
                const habitsRef = collection(db, 'users', userId, 'userHabits'); // Changed path
                // const { id, ...habitData } = habit; // This line is not needed, habit is already just data
                const docRef = await addDoc(habitsRef, habit);
                return docRef.id; 
            } catch (error) {
                console.error('Error adding habit to Firebase:', error);
                return null;
            }
        };
        
        window.updateHabitInFirebase = async (habitId, habitData) => {
             if (!window.firebaseEnabled || !window.getUserId()) return; // <-- FIX
             try {
                const userId = window.getUserId(); // <-- FIX
                const habitRef = doc(db, 'users', userId, 'userHabits', habitId); // Changed path
                await updateDoc(habitRef, habitData);
             } catch(error) {
                console.error('Error updating habit in Firebase:', error);
             }
        };
        
        window.deleteHabitFromFirebase = async (habitId) => {
             if (!window.firebaseEnabled || !window.getUserId()) return; // <-- FIX
             try {
                const userId = window.getUserId(); // <-- FIX
                const habitRef = doc(db, 'users', userId, 'userHabits', habitId); // Changed path
                await deleteDoc(habitRef);
             } catch(error) {
                console.error('Error deleting habit from Firebase:', error);
             }
        };

        window.setupRealtimeSync = function() {
            if (!window.firebaseEnabled || !window.getUserId()) return; // <-- FIX

            const userId = window.getUserId(); // <-- FIX
            
            // Sync for check-in data
            const datesRef = collection(db, 'users', userId, 'dates'); // Changed path
            onSnapshot(datesRef, (snapshot) => {
                let hasRemoteChanges = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.doc.metadata.hasPendingWrites) return; // Ignore local changes
                    
                    if (change.type === 'modified' || change.type === 'added') {
                        const dateStr = change.doc.id;
                        const data = change.doc.data();
                        window.habitData[dateStr] = data;
                        hasRemoteChanges = true;
                    }
                });
                if (hasRemoteChanges) {
                    window.saveData(); 
                    window.updateDisplay();
                }
            });
            
            // Sync for the habit list itself
            const habitsRef = collection(db, 'users', userId, 'userHabits'); // Changed path
            onSnapshot(habitsRef, (snapshot) => {
                let hasRemoteChanges = false;
                const newHabits = [];
                snapshot.forEach(doc => {
                    newHabits.push({ id: doc.id, ...doc.data() });
                });

                // Simple check to see if lists are different
                if (newHabits.length !== window.habits.length || JSON.stringify(newHabits) !== JSON.stringify(window.habits)) {
                     // Check if the change wasn't just a local write
                    if (snapshot.docChanges().some(change => !change.doc.metadata.hasPendingWrites)) {
                        window.habits = newHabits;
                        window.saveHabits(); 
                        window.renderHabits();
                        window.updateDisplay();
                    }
                }
            });
        };

        window.getUserId = function() { // <-- FIX: Made function global
            if (currentUser) {
                return currentUser.uid;
            }
            // No user, no ID.
            return null;
        }

        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (status === 'syncing') {
                syncStatus.classList.add('syncing');
                syncText.textContent = 'Syncing...';
            } else if (status === 'synced') {
                syncStatus.classList.remove('syncing');
                syncText.textContent = 'Synced';
            } else if (status === 'error') {
                syncStatus.classList.remove('syncing');
                syncText.textContent = 'Sync Error';
            }
        }
    </script>

    <script>
        // --- DATA ---
        let habitData = {}; 
        let habits = []; 
        let currentViewDate = new Date();
        
        const defaultHabits = [
            { name: "Bed before 2am", icon: "ðŸ›ï¸", color: "var(--color-preset-1)", schedule: "daily" },
            { name: "Walk or Run", icon: "ðŸƒ", color: "var(--color-preset-2)", schedule: "daily" },
            { name: "Wake up at 10", icon: "â°", color: "var(--color-preset-3)", schedule: "daily" },
            { name: "Apply to 10 jobs", icon: "ðŸ’¼", color: "var(--color-preset-4)", schedule: "weekdays" },
            { name: "Limit Instagram", icon: "ðŸ“±", color: "var(--color-preset-5)", schedule: "daily" }
        ];

        // --- INITIALIZATION ---
        function init() {
            loadData(); // Load check-in data from local
            
            // This is the fallback for local-only mode
            if (!window.firebaseEnabled) {
                (async () => {
                    await loadHabits();
                    renderHabits();
                    updateDisplay();
                })();
            }
            
            // Close menus when clicking outside
            document.addEventListener('click', function(event) {
                document.querySelectorAll('.habit-menu-dropdown.show').forEach(menu => {
                    if (!menu.parentElement.contains(event.target)) {
                        menu.classList.remove('show');
                    }
                });
            });
        }

        // --- LOGIN MODAL HELPERS ---
        function showLoginTab() {
            document.getElementById('toggleLogin').classList.add('active');
            document.getElementById('toggleRegister').classList.remove('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            window.clearAuthError();
        }
        
        function showRegisterTab() {
            document.getElementById('toggleLogin').classList.remove('active');
            document.getElementById('toggleRegister').classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            window.clearAuthError();
        }

        function handleLoginClick() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            if (!email || !pass) {
                return showAuthError('Please fill in all fields.');
            }
            window.handleLogin(email, pass);
        }

        function handleRegisterClick() {
            const email = document.getElementById('registerEmail').value;
            const pass = document.getElementById('registerPassword').value;
            if (!email || !pass) {
                 return showAuthError('Please fill in all fields.');
            }
            window.handleRegister(email, pass);
        }


        function dismissSetup() {
            document.getElementById('setupBanner').style.display = 'none';
            localStorage.setItem('setupDismissed', 'true');
        }

        // --- DATA STORAGE (CHECK-INS) ---
        function loadData() {
            const saved = localStorage.getItem('habitTrackerData');
            if (saved) {
                habitData = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('habitTrackerData', JSON.stringify(habitData));
        }
        
        // --- DATA STORAGE (HABIT LIST) ---
        window.loadHabits = async function() {
            let loadedFromFirebase = false;
            if (window.firebaseEnabled && window.getUserId()) { // <-- FIX
                const firebaseHabits = await window.loadHabitsFromFirebase();
                if (firebaseHabits) { // Allow empty list from cloud
                    habits = firebaseHabits;
                    loadedFromFirebase = true;
                }
            }
            
            if (!loadedFromFirebase) {
                 const savedHabits = localStorage.getItem('habitTrackerHabits');
                if (savedHabits) {
                    habits = JSON.parse(savedHabits);
                }
            }

            // Only add defaults if list is *truly* empty (new user)
            if (habits.length === 0) {
                await addDefaultHabits();
            }
            
            saveHabits(); // Save to local storage
        }
        
        window.saveHabits = function() {
            localStorage.setItem('habitTrackerHabits', JSON.stringify(habits));
        }
        
        async function addDefaultHabits() {
            let tempHabits = [];
            
            // Use a batch write if on Firebase
            if (window.firebaseEnabled && window.getUserId()) { // <-- FIX
                const userId = window.getUserId(); // <-- FIX
                const batch = writeBatch(db);
                defaultHabits.forEach(habit => {
                    const habitRef = doc(collection(db, 'users', userId, 'userHabits')); // Changed path
                    batch.set(habitRef, habit);
                    tempHabits.push({ ...habit, id: habitRef.id }); 
                });
                await batch.commit();
                habits = tempHabits;
                
            } else {
                // Not on Firebase, just create local IDs
                habits = defaultHabits.map(habit => ({
                    ...habit,
                    id: 'habit_' + Math.random().toString(36).substr(2, 9)
                }));
            }
            
            saveHabits();
        }

        function getDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // --- HABIT MODAL (ADD/EDIT) ---
        
        function openHabitModal(habitId) {
            const modal = document.getElementById('habitModal');
            const title = document.getElementById('modalTitle');
            const idInput = document.getElementById('habitIdInput');
            const nameInput = document.getElementById('habitNameInput');
            const iconInput = document.getElementById('habitIconInput');
            const scheduleInput = document.getElementById('habitScheduleInput');
            
            // Reset color pickers
            document.getElementById('color-1').checked = true;

            if (habitId) {
                // Edit Mode
                const habit = habits.find(h => h.id === habitId);
                if (!habit) return;
                
                title.textContent = 'Edit Habit';
                idInput.value = habit.id;
                nameInput.value = habit.name;
                iconInput.value = habit.icon;
                scheduleInput.value = habit.schedule;
                
                // Select the correct color
                const colorRadio = document.querySelector(`.color-radio[value="${habit.color}"]`);
                if (colorRadio) {
                    colorRadio.checked = true;
                }
                
            } else {
                // Add Mode
                title.textContent = 'Add New Habit';
                idInput.value = '';
                nameInput.value = '';
                iconInput.value = '';
                scheduleInput.value = 'daily';
                document.getElementById('color-1').checked = true;
            }
            
            modal.classList.add('show');
        }
        
        function closeHabitModal() {
            document.getElementById('habitModal').classList.remove('show');
        }
        
        async function saveHabit() {
            const id = document.getElementById('habitIdInput').value;
            const name = document.getElementById('habitNameInput').value.trim();
            const icon = document.getElementById('habitIconInput').value.trim();
            const schedule = document.getElementById('habitScheduleInput').value;
            const color = document.querySelector('.color-radio:checked').value;
            
            if (!name) {
                showSnackbar('Please enter a habit name.');
                return;
            }
            
            const habitData = { name, icon, schedule, color };

            if (id) {
                // Update Existing Habit
                const index = habits.findIndex(h => h.id === id);
                if (index > -1) {
                    habits[index] = { ...habits[index], ...habitData };
                    if (window.firebaseEnabled && window.getUserId()) { // <-- FIX
                        await window.updateHabitInFirebase(id, habitData);
                    }
                }
            } else {
                // Add New Habit
                let newId = 'habit_' + Math.random().toString(36).substr(2, 9);
                
                if (window.firebaseEnabled && window.getUserId()) { // <-- FIX
                    // Save to Firebase first to get the real ID
                    const firebaseId = await window.addHabitToFirebase(habitData);
                    if (firebaseId) {
                        newId = firebaseId; 
                    }
                }
                const newHabit = { id: newId, ...habitData };
                habits.push(newHabit);
            }
            
            saveHabits();
            renderHabits();
            updateDisplay();
            closeHabitModal();
            showSnackbar(id ? 'Habit updated! âœ¨' : 'Habit added! ðŸŽ‰');
        }
        
        // --- HABIT MENU & DELETE ---
        
        function openHabitMenu(event, habitId) {
            event.stopPropagation(); // Stop click from bubbling to habit-card
            
            // Close all other menus
            document.querySelectorAll('.habit-menu-dropdown.show').forEach(menu => {
                 if (menu.id !== `menu-${habitId}`) {
                    menu.classList.remove('show');
                 }
            });
            
            const menu = document.getElementById(`menu-${habitId}`);
            menu.classList.toggle('show');
        }

        function openDeleteConfirm(habitId, habitName) {
            const modal = document.getElementById('deleteModal');
            const text = document.getElementById('deleteModalText');
            const btn = document.getElementById('confirmDeleteBtn');
            
            text.innerHTML = `Are you sure you want to delete <strong>${habitName}</strong>? This action cannot be undone.`;
            btn.dataset.habitId = habitId; // Store the id on the button
            
            modal.classList.add('show');
        }

        function closeDeleteConfirm() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        async function confirmDeleteHabit() {
            const habitId = document.getElementById('confirmDeleteBtn').dataset.habitId;
            
            // Delete from Firebase
            if (window.firebaseEnabled && window.getUserId()) { // <-- FIX
                await window.deleteHabitFromFirebase(habitId);
            }
            
            // Delete from local array
            habits = habits.filter(h => h.id !== habitId);
            
            // TODO: In future, also delete check-in data from `habitData`
            
            saveHabits();
            renderHabits();
            updateDisplay();
            closeDeleteConfirm();
            showSnackbar('Habit deleted.');
        }

        // --- CORE LOGIC & RENDERING ---

        function toggleHabit(habitId, event) {
            if (event.target.type === 'checkbox') return;
            
            const checkbox = document.getElementById(`habit-${habitId}`);
            if (checkbox.disabled) return;
            
            checkbox.checked = !checkbox.checked;
            updateHabitData(habitId);
        }

        function updateHabitData(habitId) {
            const dateStr = getDateString(currentViewDate);
            const checkbox = document.getElementById(`habit-${habitId}`);
            
            if (!habitData[dateStr]) {
                habitData[dateStr] = {};
            }
            
            habitData[dateStr][habitId] = checkbox.checked;
            saveData();
            
            // Save to Firebase
            if (window.firebaseEnabled && window.saveToFirebase && window.getUserId()) { // <-- FIX
                window.saveToFirebase(dateStr, habitData[dateStr]);
            }
            
            updateDisplay();
            checkForCelebration();
        }

        function checkForCelebration() {
            const dateStr = getDateString(currentViewDate);
            const today = getDateString(new Date());
            
            if (dateStr !== today || habits.length === 0) return;
            
            const dayData = habitData[dateStr] || {};
            const allComplete = habits.every(habit => {
                if (habit.schedule === 'weekdays') {
                    const isWeekday = currentViewDate.getDay() >= 1 && currentViewDate.getDay() <= 5;
                    return !isWeekday || dayData[habit.id];
                }
                return dayData[habit.id];
            });
            
            if (allComplete) {
                showCelebration();
            }
        }

        function showCelebration() {
            const celebration = document.getElementById('celebration');
            celebration.classList.add('show');
            setTimeout(() => {
                celebration.classList.remove('show');
            }, 3000);
        }

        window.showSnackbar = function(message) {
            const snackbar = document.getElementById('snackbar');
            document.getElementById('snackbarText').textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }
        
        window.renderHabits = function() {
            const list = document.getElementById('habitsList');
            if (!list) return;
            
            list.innerHTML = ''; // Clear existing list
            
            habits.forEach(habit => {
                const scheduleText = habit.schedule === 'weekdays' ? 'Weekdays' : 'Daily';
                
                const card = document.createElement('div');
                card.className = 'habit-card';
                card.style = `--habit-color: ${habit.color};`;
                card.onclick = (e) => toggleHabit(habit.id, e);
                
                card.innerHTML = `
                    <div class="habit-checkbox-wrapper">
                        <input type="checkbox" class="habit-checkbox" id="habit-${habit.id}" onclick="event.stopPropagation()">
                    </div>
                    <div class="habit-icon">${habit.icon || 'ðŸŽ¯'}</div>
                    <div class="habit-content">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-schedule">${scheduleText}</div>
                        <div class="habit-stats-inline">
                            <div class="streak-badge" id="streak-${habit.id}">
                                <span class="material-symbols-rounded" style="font-size: 16px;">local_fire_department</span>
                                <span>0 days</span>
                            </div>
                            <div class="habit-stat-chip" id="rate-${habit.id}">0% complete</div>
                        </div>
                    </div>
                    <div class="habit-menu">
                        <button class="habit-menu-btn" onclick="openHabitMenu(event, '${habit.id}')">
                            <span class="material-symbols-rounded">more_vert</span>
                        </button>
                        <div class="habit-menu-dropdown" id="menu-${habit.id}">
                            <button onclick="event.stopPropagation(); openHabitModal('${habit.id}')">
                                <span class="material-symbols-rounded" style="font-size: 18px;">edit</span>
                                Edit
                            </button>
                            <button class="delete" onclick="event.stopPropagation(); openDeleteConfirm('${habit.id}', '${habit.name.replace(/'/g, "\\'")}')">
                                <span class="material-symbols-rounded" style="font-size: 18px;">delete</span>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                
                list.appendChild(card);
                
                // Add change listener to checkbox *after* creating it
                document.getElementById(`habit-${habit.id}`).addEventListener('change', function() {
                    updateHabitData(habit.id);
                });
            });
        }

        window.updateDisplay = function() {
            const dateStr = getDateString(currentViewDate);
            const today = getDateString(new Date());
            
            // Update date display
            const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            const currentDateEl = document.getElementById('currentDate');
            const dateSubtextEl = document.getElementById('dateSubtext');
            
            if (currentDateEl) {
                currentDateEl.textContent = currentViewDate.toLocaleDateString('en-US', options);
            }
            
            // Date subtext
            if (dateSubtextEl) {
                if (dateStr === today) {
                    dateSubtextEl.textContent = 'Today - Make it count!';
                } else if (dateStr < today) {
                    dateSubtextEl.textContent = 'Past day - Reviewing your progress';
                } else {
                    dateSubtextEl.textContent = 'Future day - Plan ahead!';
                }
            }
            
            // Allow viewing future dates
            const nextDayBtn = document.getElementById('nextDayBtn');
            if (nextDayBtn) {
                nextDayBtn.disabled = false;
            }
            
            // Update checkboxes and habit cards
            const dayData = habitData[dateStr] || {};
            let todayComplete = 0;
            let totalHabits = 0;
            
            habits.forEach(habit => {
                const habitId = habit.id;
                const checkbox = document.getElementById(`habit-${habitId}`);
                if (!checkbox) return; // Habit card might not be rendered yet
                
                const habitCard = checkbox.closest('.habit-card');
                const isWeekday = currentViewDate.getDay() >= 1 && currentViewDate.getDay() <= 5;
                
                // Handle weekday-only habits
                if (habit.schedule === 'weekdays' && !isWeekday) {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    habitCard.style.opacity = '0.5';
                } else {
                    checkbox.disabled = false;
                    checkbox.checked = dayData[habitId] || false;
                    habitCard.style.opacity = '1';
                    totalHabits++;
                    if (checkbox.checked) {
                        todayComplete++;
                        habitCard.classList.add('completed');
                    } else {
                        habitCard.classList.remove('completed');
                    }
                }
                
                // Update individual habit stats
                updateHabitStats(habitId);
            });
            
            // Update progress ring
            updateProgressRing(todayComplete, totalHabits);
            
            // Update stats
            const weekProgressEl = document.getElementById('weekProgress');
            if (weekProgressEl) weekProgressEl.textContent = calculateWeekProgress() + '%';
            
            const totalCheckinsEl = document.getElementById('totalCheckins');
            if (totalCheckinsEl) totalCheckinsEl.textContent = calculateTotalCheckins();
            
            const bestStreakEl = document.getElementById('bestStreak');
            if (bestStreakEl) bestStreakEl.textContent = calculateBestStreak();
            
            const avgCompletionEl = document.getElementById('avgCompletion');
            if (avgCompletionEl) avgCompletionEl.textContent = calculateAvgCompletion() + '%';
        }

        function updateProgressRing(completed, total) {
            const circle = document.getElementById('progressCircle');
            const text = document.getElementById('progressText');
            if (!circle || !text) return; // Add guard clause
            
            const radius = 52;
            const circumference = 2 * Math.PI * radius;
            
            const progress = total > 0 ? (completed / total) : 0;
            const offset = circumference - (progress * circumference);
            
            circle.style.strokeDashoffset = offset;
            text.textContent = `${completed}/${total}`;
        }

        function updateHabitStats(habitId) {
            const streak = calculateStreak(habitId);
            const rate = calculateCompletionRate(habitId);
            
            const streakElement = document.getElementById(`streak-${habitId}`);
            if (streakElement) {
                streakElement.querySelector('span:last-child').textContent = `${streak} days`;
            }
            
            const rateElement = document.getElementById(`rate-${habitId}`);
            if (rateElement) {
                rateElement.textContent = `${rate}% complete`;
            }
        }

        function calculateStreak(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;

            let streak = 0;
            let checkDate = new Date();
            
            while (true) {
                const dateStr = getDateString(checkDate);
                const dayData = habitData[dateStr] || {};
                
                // Check if habit was applicable
                const isWeekday = checkDate.getDay() >= 1 && checkDate.getDay() <= 5;
                const wasApplicable = (habit.schedule !== 'weekdays' || isWeekday);
                
                if (wasApplicable && dayData[habitId]) {
                    streak++;
                } else if (!wasApplicable) {
                    // Skip this day, don't break streak
                } else if (getDateString(checkDate) === getDateString(new Date())) {
                    // Today, not completed, don't count but don't break
                } else {
                    // Past day, was applicable, but not done
                    break;
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
                if (streak > 3650) break; // Safety break
            }
            
            return streak;
        }

        function calculateCompletionRate(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return 0;
            
            // Find the first check-in day to start counting from
            let startDate = null;
            const sortedDates = Object.keys(habitData).sort();
            for(const dateStr of sortedDates) {
                if(habitData[dateStr][habitId] !== undefined) {
                    startDate = new Date(dateStr);
                    break;
                }
            }
            
            // If no data, rate is 0
            if (!startDate) return 0;

            const today = new Date();
            let totalDays = 0;
            let completedDays = 0;
            
            let checkDate = new Date(startDate);
            while (checkDate <= today) {
                const isWeekday = checkDate.getDay() >= 1 && checkDate.getDay() <= 5;
                
                if (habit.schedule !== 'weekdays' || isWeekday) {
                    totalDays++;
                    const dateStr = getDateString(checkDate);
                    const dayData = habitData[dateStr] || {};
                    if (dayData[habitId]) {
                        completedDays++;
                    }
                }
                
                checkDate.setDate(checkDate.getDate() + 1);
            }
            
            return totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;
        }

        function calculateWeekProgress() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            
            let totalPossible = 0;
            let totalCompleted = 0;
            
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(weekStart);
                checkDate.setDate(weekStart.getDate() + i);
                
                if (checkDate > today) break;
                
                const dateStr = getDateString(checkDate);
                const dayData = habitData[dateStr] || {};
                
                habits.forEach(habit => {
                    const isWeekday = checkDate.getDay() >= 1 && checkDate.getDay() <= 5;
                    if (habit.schedule !== 'weekdays' || isWeekday) {
                        totalPossible++;
                        if (dayData[habit.id]) {
                            totalCompleted++;
                        }
                    }
                });
            }
            
            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }

        function calculateTotalCheckins() {
            let total = 0;
            Object.values(habitData).forEach(dayData => {
                Object.values(dayData).forEach(checked => {
                    if (checked) total++;
                });
            });
            return total;
        }

        function calculateBestStreak() {
            let bestStreak = 0;
            habits.forEach(habit => {
                const streak = calculateStreak(habit.id);
                if (streak > bestStreak) {
                    bestStreak = streak;
                }
            });
            return bestStreak;
        }

        function calculateAvgCompletion() {
            if (habits.length === 0) return 0;
            
            let total = 0;
            habits.forEach(habit => {
                const rate = calculateCompletionRate(habit.id);
                total += rate;
            });
            
            return Math.round(total / habits.length);
        }

        function changeDate(days) {
            currentViewDate.setDate(currentViewDate.getDate() + days);
            updateDisplay();
        }

        function goToToday() {
            currentViewDate = new Date();
            updateDisplay();
            showSnackbar('Back to today! ðŸ“…');
        }

        function exportToCSV() {
            if (habits.length === 0) {
                showSnackbar('No habits to export.');
                return;
            }

            // Dynamic headers
            let csv = 'Date,';
            csv += habits.map(h => `"${h.name}"`).join(',') + '\n';
            
            // Find start and end dates from data
            const dates = Object.keys(habitData);
            if (dates.length === 0) {
                 showSnackbar('No data to export.');
                return;
            }
            
            dates.sort();
            const startDate = new Date(dates[0]);
            const endDate = new Date(); // Go up to today
            
            let checkDate = new Date(startDate);
            while (checkDate <= endDate) {
                const dateStr = getDateString(checkDate);
                const dayData = habitData[dateStr] || {};
                
                csv += `${dateStr},`;
                
                csv += habits.map(h => {
                    return dayData[h.id] ? 'Yes' : 'No';
                }).join(',') + '\n';
                
                checkDate.setDate(checkDate.getDate() + 1);
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-${getDateString(new Date())}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSnackbar('CSV downloaded successfully! ðŸ’¾');
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
